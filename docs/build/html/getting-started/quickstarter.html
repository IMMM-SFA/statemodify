
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Quickstarter &#8212; statemodify documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=f6d3da1f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=a5fa425f"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'getting-started/quickstarter';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Useful Links" href="useful_links.html" />
    <link rel="prev" title="Installation" href="installation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_statemodify.png" class="logo__image only-light" alt="statemodify documentation - Home"/>
    <script>document.write(`<img src="../_static/logo_statemodify.png" class="logo__image only-dark" alt="statemodify documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Quickstarter</a></li>
<li class="toctree-l1"><a class="reference internal" href="useful_links.html">Useful Links</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/api.html">Python API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/contributing.html">Contributing to <strong>statemodify</strong></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/IMMM-SFA/statemodify" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/IMMM-SFA/statemodify/edit/main/docs/source/getting-started/quickstarter.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/IMMM-SFA/statemodify/issues/new?title=Issue%20on%20page%20%2Fgetting-started/quickstarter.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/getting-started/quickstarter.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Quickstarter</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-1-getting-started-and-using-the-ddm-and-ddr-modification-functions-in-the-san-juan-river-basin"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #1: Getting Started and Using the DDM and DDR Modification Functions in the San Juan River Basin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin">Step 1: Run a Historical Simulation in StateMod for the San Juan Basin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example">Step 2a: Modify StateMod Input Files for Exploratory Analyses- Demand Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example">Step 2b: Read in the New Input Files and Run StateMod : Demand Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2c-visualize-shortages-in-new-sows-demand-function-example">Step 2c: Visualize Shortages in New SOWs- Demand Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example">Step 3a: Modify StateMod Input Files for Exploratory Analyses- Water Rights Function Example</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-2-using-the-eva-modification-function-in-the-gunnison-river-basin"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #2 : Using the EVA Modification Function in the Gunnison River Basin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-gunnison-subbasin">Step 1: Run a Historical Simulation in StateMod for the Gunnison Subbasin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-modify-statemod-input-files-for-exploratory-analyses-evaporation-function-example">Step 2: Modify StateMod Input Files for Exploratory Analyses- Evaporation Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-read-in-the-new-input-files-and-run-statemod-evaporation-example">Step 3: Read in the New Input Files and Run StateMod : Evaporation Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-visualize-reservoir-levels-in-new-sows">Step 4: Visualize Reservoir Levels in New SOWs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-3-using-the-res-modification-function-in-the-upper-colorado-river-basin"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #3 : Using the RES Modification Function in the Upper Colorado River Basin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-uppper-colorado-subbasin">Step 1: Run a Historical Simulation in StateMod for the Uppper Colorado Subbasin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-modify-statemod-input-files-for-exploratory-analyses-reservoir-function-example">Step 2: Modify StateMod Input Files for Exploratory Analyses- Reservoir Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-read-in-the-new-input-files-and-run-statemod-reservoir-example">Step 3: Read in the New Input Files and Run StateMod : Reservoir Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-references">Notebook References</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-4-using-external-methods-to-generate-synthetic-streamflow-traces"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #4: Using External Methods to Generate Synthetic Streamflow Traces</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-fit-multi-site-hmm">Step 1: Fit Multi-Site HMM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-sample-from-multi-site-hmm">Step 2: Sample from multi-site HMM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-modify-statemod-input-files-for-exploratory-analyses-streamflow-example">Step 3: Modify StateMod Input Files for Exploratory Analyses- Streamflow Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-read-in-the-new-input-files-and-run-statemod-streamflow-example">Step 4: Read in the New Input Files and Run StateMod : Streamflow Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-specific-references">Notebook Specific References</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-5-sampling-multiple-uncertainties"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #5 : Sampling Multiple Uncertainties</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-creating-a-sample-across-multiple-uncertainties">Step 1: Creating a Sample Across Multiple Uncertainties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-running-a-simulation">Step 2: Running a Simulation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="quickstarter">
<h1>Quickstarter<a class="headerlink" href="#quickstarter" title="Link to this heading">#</a></h1>
<p>To demonstrate the functionality of <strong>statemodify</strong>, we have generated 5 notebooks that highlight how to use the functions in the package and show some very basic analyses that can be done with the output data. Each notebook demonstrates one to two <strong>statemodify</strong> functions for a specific West Slope basin in Colorado. The notebooks usually follow a specific form:</p>
<ol class="arabic simple">
<li><p>Run a baseline simulation for the basin (about 4 minutes)</p></li>
<li><p>Plot the baseline shortages for specific users or reservoir storage</p></li>
<li><p>Introduce a <strong>statemodify</strong> function that samples a specific uncertainty (evaporation, demand, streamflow, water rights, etc.)</p></li>
<li><p>Create a new set of input files to run through StateMod</p></li>
<li><p>Run each StateMod simulation (usually about 2 simulations, each at 4 minutes)</p></li>
<li><p>Plot the new shortages or reservoir levels with respect to the baseline values.</p></li>
</ol>
<p>The notebooks are hosted in MSD-LIVE containers and can be found at: <cite>https:/statemodify.msdlive.org &lt;https:/statemodify.msdlive.org&gt;</cite></p>
<p>You will be taken to a JupyterLab homepage with “data” and “notebook” buckets on the side.  The “data” directory contains all the StateMod datasets and some other template files. Click on the “notebooks” directory and choose a notebook to start. Press “shift + enter” to execute the cells in the notebook.</p>
<figure class="align-default" id="id1">
<img alt="JupyterLab home screen" src="../_images/quickstarter_1.png" />
<figcaption>
<p><span class="caption-text">Figure 1: JupyterLab home screen</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>IMPORTANT: When you finish a notebook and move on to another one, please restart the kernel and clear the outputs as shown below.</p>
<figure class="align-default" id="id2">
<img alt="Restarting the Kernel" src="../_images/quickstarter_2.png" />
<figcaption>
<p><span class="caption-text">Figure 1: Restarting the Kernel</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The table below lists the</p>
<table class="table" id="id3">
<caption><span class="caption-text">Notebook Topics</span><a class="headerlink" href="#id3" title="Link to this table">#</a></caption>
<colgroup>
<col style="width: 9.1%" />
<col style="width: 18.2%" />
<col style="width: 18.2%" />
<col style="width: 18.2%" />
<col style="width: 18.2%" />
<col style="width: 18.2%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Topic</p></th>
<th class="head"><p>Notebook 1: Getting Started and using the DDM and DDR modification functions in the San Juan Subbasin</p></th>
<th class="head"><p>Notebook 2: Using the EVA modification functions in the Gunnison Subbasin</p></th>
<th class="head"><p>Notebook 3: Using the RES modification function in the Upper Colorado Subbasin</p></th>
<th class="head"><p>Notebook 4: Using the XBM and IWR modification functions across all basins</p></th>
<th class="head"><p>Notebook 5: Sampling multiple uncertainties</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Description</p></td>
<td><p>This notebook has more general intro information on <strong>statemodify</strong> and shows how changes to demand and water rights can lead to changes to user shortages in the San Juan Subbasin.</p></td>
<td><p>This notebook looks at how changes in evaporation in  reservoirs in the Gunnison subbasin lead to changes to reservoir levels</p></td>
<td><p>This notebook looks at how changes in storage in reservoirs in the Upper Colorado subbasin lead to changes to user shortages</p></td>
<td><p>This notebook debuts the stationary Hidden Markov Model to generate alternative streamflow scenarios across the basins.</p></td>
<td><p>This notebook demonstrates how to create a global Latin hypercube sample to consider multiple uncertainties in a basin.</p></td>
</tr>
</tbody>
</table>
<section id="statemodify-quickstarter-notebook-1-getting-started-and-using-the-ddm-and-ddr-modification-functions-in-the-san-juan-river-basin">
<h2><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #1: Getting Started and Using the DDM and DDR Modification Functions in the San Juan River Basin<a class="headerlink" href="#statemodify-quickstarter-notebook-1-getting-started-and-using-the-ddm-and-ddr-modification-functions-in-the-san-juan-river-basin" title="Link to this heading">#</a></h2>
<p>In this series of five notebooks, we demonstrate the functionality of
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> using three of the five subbasins on the West Slope
basin in the state of Colorado: Gunnison, San Juan/Dolores, and the
Upper Colorado Basin. There are two classes of adjustments offered in
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> that can be used to create alternative future states of
the world for the region:</p>
<ol class="arabic simple">
<li><p>Application of multipliers or additives to the original dataset which
are sampled from specified bounds using a Latin hypercube sample</p></li>
<li><p>Complete swap of input data with data generated from an external
method</p></li>
</ol>
<p>Option 1 is applicable to <code class="docutils literal notranslate"><span class="pre">.ddm</span></code> (monthly demand), <code class="docutils literal notranslate"><span class="pre">.ddr</span></code> (water
rights), <code class="docutils literal notranslate"><span class="pre">.eva</span></code> (reservoir evaporation), <code class="docutils literal notranslate"><span class="pre">.res</span></code> (reservoir storage).</p>
<p>Option 2 is applicable to <code class="docutils literal notranslate"><span class="pre">.xbm</span></code> (monthly streamflow) and <code class="docutils literal notranslate"><span class="pre">.iwr</span></code>
(irrigation demand). In <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> we provide a Hidden Markov Model
(HMM)-based approach to generate synthetic flows across the basins and
tie in irrigation demand to be negatively correlated to increased
streamflow.</p>
<p>In this first notebook, we will demonstrate now to use the demand
(<code class="docutils literal notranslate"><span class="pre">modify_ddm()</span></code>)and water rights (<code class="docutils literal notranslate"><span class="pre">modify_ddr()</span></code>) modification
functions in the San Juan River Basin. Demands are projected to increase
with the growth of cities and agriculture and water rights will likely
change as discussions on changes to the Colorado Compact and
re-allocation of water across the Colorado River Basin to promote
sustainable development continue.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: When each StateMod file is mentioned, clicking on the name will
link the user to the StateMod documentation with more information on
that file.</p>
</div>
<section id="step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin">
<h3>Step 1: Run a Historical Simulation in StateMod for the San Juan Basin<a class="headerlink" href="#step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin" title="Link to this heading">#</a></h3>
<p>Before we start on an exploratory modeling journey, you may be first
interested in understanding water shortages that the basin has
historically experienced. In the container, we have downloaded and
compiled StateMod, <code class="docutils literal notranslate"><span class="pre">statemodify</span></code>, and the San Juan dataset from the
Colorado’s Decision Support System (CDSS) website. We can run a baseline
simulation below which takes approximately 4 minutes. In this baseline
simulation, we run StateMod over the length of the historical period
(105 years) under the assumption that we are starting from current
conditions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import argparse
import logging
import os
import pickle
from string import Template
import subprocess

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import statemodify as stm
</pre></div>
</div>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: Each simulation in this notebook is run for the length of the
historical period (from 1909-2013). If you want to reduce the length
of the simulation, navigate to the <code class="docutils literal notranslate"><span class="pre">.ctl</span></code> file and adjust the
<code class="docutils literal notranslate"><span class="pre">iystr</span></code> and <code class="docutils literal notranslate"><span class="pre">iyend</span></code> variables. For this notebook, these files are
located in:
<code class="docutils literal notranslate"><span class="pre">data/sj2015_StateMod_modified/sj2015_StateMod_modified/StateMod</span> <span class="pre">Notebook/sj2015.ctl</span></code>
and
<code class="docutils literal notranslate"><span class="pre">data/gm2015_StateMod_modified/gm2015_StateMod_modified/StateMod/gm2015.ctl</span></code></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># statemod directory
statemod_dir = &quot;/usr/src/statemodify/statemod_gunnison_sjd&quot;

# root directory of statemod data for the target basin
root_dir = os.path.join(statemod_dir, &quot;src&quot;, &quot;main&quot;, &quot;fortran&quot;)

# home directory of notebook instance
home_dir = os.path.dirname(os.getcwd())

# path to the statemod executable
statemod_exe = os.path.join(root_dir, &quot;statemod-17.0.3-gfortran-lin-64bit-o3&quot;)

# data directory and root name for the target basin
data_dir = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;sj2015_StateMod_modified&quot;,
    &quot;sj2015_StateMod_modified&quot;,
    &quot;StateMod&quot;
)

# directory to the target basin input files with root name for the basin
basin_path = os.path.join(data_dir, &quot;sj2015B&quot;)

# scenarios output directory
scenarios_dir_ddm = os.path.join(data_dir, &quot;scenarios_ddm&quot;)
scenarios_dir_ddr = os.path.join(data_dir, &quot;scenarios_ddr&quot;)

# parquet files output directory
parquet_dir_ddm = os.path.join(data_dir, &quot;parquet_ddm&quot;)
parquet_dir_ddr = os.path.join(data_dir, &quot;parquet_ddr&quot;)

# path to ddm and ddr template file
ddm_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;sj2015B_template_ddm.rsp&quot;
)

ddr_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;sj2015B_template_ddr.rsp&quot;
)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># run statemod
subprocess.call([statemod_exe, basin_path, &quot;-simulate&quot;])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">sj2015B</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">sj2015B</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">sj2015B</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Once StateMod has run successfully, we can now extract user shortages
from the
<code class="docutils literal notranslate"><span class="pre">`.xdd</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/521/">https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/521/</a>&gt;`__
output file using the <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> output modification function
<code class="docutils literal notranslate"><span class="pre">convert_xdd()</span></code>. We denote a list of user IDs
(‘2900501’,‘2900519’,‘2900555’) who we want to extract shortages for and
then these shortages are saved in a compressed Parquet file format that
can then be read in as a Pandas dataframe in Python. We can also remove
the larger output files once the requested shortages have been extracted
and saved.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#Extract shortages using statemodify convert_xdd() function

# create a directory to store the historical shortages
output_dir = os.path.join(data_dir, &quot;historic_shortages&quot;)

# create a directory to store the new files in if it does not exist
output_directory = os.path.join(data_dir, &quot;historic_shortages&quot;)
if not os.path.exists(output_directory):
    os.makedirs(output_directory)

stm.xdd.convert_xdd(
    # path to a directory where output .parquet files should be written
    output_path=output_dir,
    # whether to abort if .parquet files already exist at the output_path
    allow_overwrite=True,
    # path, glob, or a list of paths/globs to the .xdd files you want to convert
    xdd_files=os.path.join(data_dir, &quot;*.xdd&quot;),
    # if the output .parquet files should only contain a subset of structure ids, list them here; None for all
    id_subset=[&#39;2900501&#39;,&#39;2900519&#39;,&#39;2900555&#39;],
    # how many .xdd files to convert in parallel; optimally you will want 2-4 CPUs per parallel process
    parallel_jobs=4,
    # convert to natural data types
    preserve_string_dtype=False
)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 29.32it/s]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data=pd.read_parquet(os.path.join(output_dir,&#39;sj2015B.parquet&#39;),engine=&#39;pyarrow&#39;)
data
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>structure_name</th>
      <th>structure_id</th>
      <th>river_id</th>
      <th>year</th>
      <th>month</th>
      <th>demand_total</th>
      <th>demand_cu</th>
      <th>from_river_by_priority</th>
      <th>from_river_by_storage</th>
      <th>from_river_by_other</th>
      <th>...</th>
      <th>station_in_out_return_flow</th>
      <th>station_in_out_well_deplete</th>
      <th>station_in_out_from_to_groundwater_storage</th>
      <th>station_balance_river_inflow</th>
      <th>station_balance_river_divert</th>
      <th>station_balance_river_by_well</th>
      <th>station_balance_river_outflow</th>
      <th>available_flow</th>
      <th>control_location</th>
      <th>control_right</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>15015</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1908</td>
      <td>OCT</td>
      <td>13.0</td>
      <td>7.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3792.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>3779.0</td>
      <td>2918.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15016</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1908</td>
      <td>NOV</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2343.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2343.0</td>
      <td>1510.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15017</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1908</td>
      <td>DEC</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1721.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1721.0</td>
      <td>860.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15018</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1909</td>
      <td>JAN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1512.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1512.0</td>
      <td>525.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15019</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1909</td>
      <td>FEB</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1370.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1370.0</td>
      <td>510.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>118750</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>JUN</td>
      <td>426.0</td>
      <td>81.0</td>
      <td>426.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>711.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>29239.0</td>
      <td>426.0</td>
      <td>0.0</td>
      <td>28813.0</td>
      <td>26410.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118751</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>JUL</td>
      <td>314.0</td>
      <td>88.0</td>
      <td>314.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>581.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9580.0</td>
      <td>314.0</td>
      <td>0.0</td>
      <td>9266.0</td>
      <td>7180.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118752</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>AUG</td>
      <td>203.0</td>
      <td>59.0</td>
      <td>203.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>524.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>20441.0</td>
      <td>203.0</td>
      <td>0.0</td>
      <td>20238.0</td>
      <td>18989.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118753</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>SEP</td>
      <td>144.0</td>
      <td>39.0</td>
      <td>144.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>454.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>42214.0</td>
      <td>144.0</td>
      <td>0.0</td>
      <td>42070.0</td>
      <td>41359.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118754</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>TOT</td>
      <td>1341.0</td>
      <td>328.0</td>
      <td>1341.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>3395.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>228506.0</td>
      <td>1341.0</td>
      <td>0.0</td>
      <td>227165.0</td>
      <td>215605.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
  </tbody>
</table>
<p>4095 rows × 36 columns</p>
</div><p>Upon inspecting the Parquet file above, we see the contents of the
<code class="docutils literal notranslate"><span class="pre">.xdd</span></code> file, including the shortages experienced by the structures
that we specified for the length of the historical period.</p>
<p>We can then take these shortages and plot them for our list of users.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots()

for name, group in data.groupby(&#39;structure_id&#39;):
    ax.scatter(
        group[&#39;year&#39;], group[&#39;shortage_total&#39;], label=name)

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7f17d8d6ea70</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_15_1.png" src="../_images/output_15_1.png" />
<p>You can look up the names and rights of the users listed above in the
<code class="docutils literal notranslate"><span class="pre">sj2015.ddr</span></code> file (found at
<code class="docutils literal notranslate"><span class="pre">data/sj2015_StateMod_modified/sj2015_StateMod_modified/StateMod/sj2015.ddr</span></code>).
Here, a higher Admin # denotes lower seniority. You’ll see that the
users chosen here have junior to medium seniority of water rights with
varying amounts of water decreed to them. The figure above shows that
all users have experienced shortages. User 2900501 has experienced the
most frequent shortages respectively, likely due in part to their less
senior water right. Generally, we see a higher magnitude of shortages
for all users during the 2002 drought.</p>
</section>
<section id="step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example">
<h3>Step 2a: Modify StateMod Input Files for Exploratory Analyses- Demand Function Example<a class="headerlink" href="#step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example" title="Link to this heading">#</a></h3>
<p>Now that we’ve run StateMod in baseline mode, the next step shows how we
can run it in an exploratory analysis mode. To do this, we need to
create some plausible futures and adjust the input files of StateMod to
reflect these changes. In this step, we’ll demonstrate Option 1 for
statemodify adjustments using the
<code class="docutils literal notranslate"><span class="pre">`.ddm</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/417/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/417/</a>&gt;`__
file as an example, which involves multiplying the current demand time
series for these users by a value in between 0.5 to 1.5. Here we specify
the IDs of the users and the bounds from which we want to sample
multipliers for the demand. We create 2 alternative states of the world
(SOW) using a Latin hypercube sampling (LHS) procedure and store them in
the <code class="docutils literal notranslate"><span class="pre">input_files</span></code> directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># a dictionary to describe what users you want to modify and the bounds for the LHS
setup_dict = {
    &quot;ids&quot;: [&quot;2900501&quot;, &quot;2900519&quot;,&quot;2900555&quot;],
    &quot;bounds&quot;: [0.5, 1.5]
}

output_directory = output_dir = os.path.join(data_dir, &quot;input_files&quot;)

scenario = &quot;1&quot;

# the number of samples you wish to generate
n_samples = 2

# seed value for reproducibility if so desired
seed_value = 1

# number of rows to skip in file after comment
skip_rows = 1

# name of field to query
query_field = &quot;id&quot;

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = -1

# basin to process
basin_name = &quot;San_Juan&quot;

# generate a batch of files using generated LHS
stm.modify_ddm(
    modify_dict=setup_dict,
    query_field=query_field,
    output_dir=output_directory,
    scenario=scenario,
    basin_name=basin_name,
    sampling_method=&quot;LHS&quot;,
    n_samples=n_samples,
    skip_rows=skip_rows,
    n_jobs=n_jobs,
    seed_value=seed_value,
    template_file=None,
    factor_method=&quot;multiply&quot;,
    data_specification_file=None,
    min_bound_value=-0.5,
    max_bound_value=1.5,
    save_sample=True
)
</pre></div>
</div>
<p>It’s helpful to set <code class="docutils literal notranslate"><span class="pre">save_sample=True</span></code> to see the values of the
multipliers that we are creating. We see below that in our 1st SOW, we
are reducing demand for our users by 30% and then in our 2nd SOW, we are
increasing demand for our users by 36%.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sample_array = np.load(output_directory+&#39;/ddm_2-samples_scenario-1.npy&#39;)
sample_array
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">0.708511</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">1.36016225</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example">
<h3>Step 2b: Read in the New Input Files and Run StateMod : Demand Function Example<a class="headerlink" href="#step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example" title="Link to this heading">#</a></h3>
<p>Now that we have created the input files, the next step is to run
StateMod with the new input files. The file that StateMod uses to
configure a simulation is called a
<code class="docutils literal notranslate"><span class="pre">`.rsp</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/41/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/41/</a>&gt;`__
file. For this dataset, the configuration file is <code class="docutils literal notranslate"><span class="pre">sj2015B.rsp</span></code>. This
file contains the paths of all of the supporting files that StateMod
needs to run. We create a template .rsp file
(<code class="docutils literal notranslate"><span class="pre">sj2015B_template_ddm.rsp</span></code>) and swap in the path to the two new
alternative <code class="docutils literal notranslate"><span class="pre">.ddm</span></code> files that are created. Then we run StateMod for
the two scenarios and store the shortages in Parquet file format. Each
scenario will take approximately 4 minutes.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 2, 1)

# read RSP template
with open(ddm_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;DDM&quot;: f&quot;../../input_files/sj2015B_{scenario}.ddm&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir_ddm, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}&quot;)

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])

        #Save output to parquet files
        print(&#39;creating parquet for &#39; + scenario)

        output_directory = os.path.join(parquet_dir_ddm+&quot;/scenario/&quot;+ scenario)

        if not os.path.exists(output_directory):
            os.makedirs(output_directory)

        stm.xdd.convert_xdd(
            output_path=output_directory,
            allow_overwrite=False,
            xdd_files=scenarios_dir_ddm + &quot;/&quot;+ scenario + &quot;/sj2015B_&quot;+scenario+&quot;.xdd&quot;,
            id_subset=[&#39;2900501&#39;,&#39;2900519&#39;,&#39;2900555&#39;],
            parallel_jobs=4,
            preserve_string_dtype=False
        )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
 <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddm</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddm</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddm</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
<span class="n">creating</span> <span class="n">parquet</span> <span class="k">for</span> <span class="n">S0_1</span>
</pre></div>
</div>
</section>
<section id="step-2c-visualize-shortages-in-new-sows-demand-function-example">
<h3>Step 2c: Visualize Shortages in New SOWs- Demand Function Example<a class="headerlink" href="#step-2c-visualize-shortages-in-new-sows-demand-function-example" title="Link to this heading">#</a></h3>
<p>Now that we have run our simulations, we can visualize the difference in
shortages experienced by the stakeholders in our two SOWs. Let’s focus
on the user: 2900501, a junior user who experienced the most frequent
shortages historically across the stakeholders we looked at. Let’s look
back at the LHS sample and see that SOW 1 is where we have a decreased
demand (0.7 multiplier) and SOW 2 is where we have an increased demand
(1.4 multiplier).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output_directory = os.path.join(data_dir, &quot;input_files&quot;)
sample_array = np.load(output_directory+&#39;/ddm_2-samples_scenario-1.npy&#39;)
sample_array
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">0.708511</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">1.36016225</span><span class="p">]])</span>
</pre></div>
</div>
<p>Now we can define shortages in the alternative states of the world with
respect to the shortages received in the baseline case.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Read in raw parquet files
baseline=pd.read_parquet(data_dir+&#39;/historic_shortages/sj2015B.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_1=pd.read_parquet(parquet_dir_ddm+&#39;/scenario/S0_1/sj2015B_S0_1.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_2=pd.read_parquet(parquet_dir_ddm+&#39;/scenario/S1_1/sj2015B_S1_1.parquet&#39;,engine=&#39;pyarrow&#39;)

# Subtract shortages with respect to the baseline
subset_df=pd.concat([baseline[&#39;year&#39;],baseline[&#39;shortage_total&#39;],SOW_1[&#39;shortage_total&#39;],SOW_2[&#39;shortage_total&#39;]],axis=1)
subset_df = subset_df.set_axis([&#39;Year&#39;, &#39;Baseline&#39;, &#39;SOW_1&#39;,&#39;SOW_2&#39;], axis=1)
subset_df[&#39;SOW_1_diff&#39;] = subset_df[&#39;SOW_1&#39;]-subset_df[&#39;Baseline&#39;]
subset_df[&#39;SOW_2_diff&#39;] = subset_df[&#39;SOW_2&#39;]-subset_df[&#39;Baseline&#39;]

# Plot shortages
fig, ax = plt.subplots()

ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;SOW_1_diff&#39;],label=&#39;Decreased Demand&#39;)
ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;SOW_2_diff&#39;],label=&#39;Increased Demand&#39;)

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.title(&quot;Change in Shortages from the Baseline&quot;)
plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7fd2d4fcae90</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_29_1.png" src="../_images/output_29_1.png" />
<p>As expected, we see that an increase in demand typically causes an
increase in shortage magnitude and frequency whereas the reduction in
demand leads to the opposite. This finishes our simple example to
demonstrate how adjustments to demand might change the shortages
experienced by a user.</p>
</section>
<section id="step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example">
<h3>Step 3a: Modify StateMod Input Files for Exploratory Analyses- Water Rights Function Example<a class="headerlink" href="#step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example" title="Link to this heading">#</a></h3>
<p>Following from Step 2, we can run the same analysis for the function
that manipulates the <code class="docutils literal notranslate"><span class="pre">sj2015.ddr</span></code> file, which corresponds to users
water rights. In this function, we can specify the IDs of the users and
can can utilize a variety of options for how we want to change the
<code class="docutils literal notranslate"><span class="pre">`.ddr</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/46/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/46/</a>&gt;`__
file. We can either sample from some bounds that apply multipliers to
the decree, hard code in values for the decree, or adjust the rank of
the user. In this simple example, we take a very junior user, ID:
2900501, and make them have the highest water right by changing their
rank to 1.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># a dictionary to describe what you want to modify and the bounds for the LHS
setup_dict = {
    # ids can either be &#39;struct&#39; or &#39;id&#39; values
    &quot;ids&quot;: [&quot;2900501&quot;],

    # turn id on or off completely or for a given period
    # if 0 = off, 1 = on, YYYY = on for years &gt;= YYYY, -YYYY = off for years &gt; YYYY; see file header
    &quot;on_off&quot;: [1],

    # apply rank of administrative order where 0 is lowest (senior) and n is highest (junior); None is no change
    &quot;admin&quot;: [1],
}

output_directory = os.path.join(data_dir, &quot;input_files&quot;)
scenario = &quot;1&quot;

# the number of samples you wish to generate
n_samples = 1

# seed value for reproducibility if so desired
seed_value = 1

# number of rows to skip in file after comment
skip_rows = 0

# name of field to query
query_field = &quot;struct&quot;

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = -1

# basin to process
basin_name = &quot;San_Juan&quot;

# generate a batch of files using generated LHS
stm.modify_ddr(
    modify_dict=setup_dict,
    query_field=query_field,
    output_dir=output_directory,
    scenario=scenario,
    basin_name=basin_name,
    sampling_method=&quot;LHS&quot;,
    n_samples=n_samples,
    skip_rows=skip_rows,
    n_jobs=n_jobs,
    seed_value=seed_value,
    template_file=None,
    factor_method=&quot;multiply&quot;,
    data_specification_file=None,
    min_bound_value=-0.5,
    max_bound_value=1.5,
    save_sample=True
)
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">input_files</span></code> directory, you can open the <code class="docutils literal notranslate"><span class="pre">sj2015B_S0_1.ddr</span></code>
file and see that the Admin # of our selected user has now become
1.0000. Now we rerun our code to do the StateMod simulation, this time
using the .<code class="docutils literal notranslate"><span class="pre">ddr</span></code> template file.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 1, 1)

# read RSP template
with open(ddr_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;DDR&quot;: f&quot;../../input_files/sj2015B_{scenario}.ddr&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir_ddr, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}&quot;)

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])

        #Save output to parquet files
        print(&#39;creating parquet for &#39; + scenario)

        output_directory = os.path.join(parquet_dir_ddr+&quot;/scenario/&quot;+ scenario)

        if not os.path.exists(output_directory):
            os.makedirs(output_directory)

        stm.xdd.convert_xdd(
            output_path=output_directory,
            allow_overwrite=False,
            xdd_files=scenarios_dir_ddr + &quot;/&quot;+ scenario + &quot;/sj2015B_&quot;+scenario+&quot;.xdd&quot;,
            id_subset=[&#39;2900501&#39;],
            parallel_jobs=2,
            preserve_string_dtype=False
        )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
 <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddr</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddr</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddr</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
<span class="n">creating</span> <span class="n">parquet</span> <span class="k">for</span> <span class="n">S0_1</span>
</pre></div>
</div>
<p>As before, let’s go ahead and plot the shortages for our User 2900501
with respect to the baseline shortages.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Read in raw parquet files
baseline=pd.read_parquet(data_dir+&#39;/historic_shortages/sj2015B.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_1=pd.read_parquet(parquet_dir_ddr+ &#39;/scenario/S0_1/sj2015B_S0_1.parquet&#39;,engine=&#39;pyarrow&#39;)

# Subtract shortages with respect to the baseline
subset_df=pd.concat([baseline[&#39;year&#39;],baseline[&#39;shortage_total&#39;],SOW_1[&#39;shortage_total&#39;]],axis=1)
subset_df = subset_df.set_axis([&#39;Year&#39;, &#39;Baseline&#39;, &#39;SOW_1&#39;], axis=1)
subset_df[&#39;diff&#39;]=subset_df[&#39;SOW_1&#39;]-subset_df[&#39;Baseline&#39;]

# Plot shortages
fig, ax = plt.subplots()

ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;diff&#39;])

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.title(&quot;Change in Shortages from the Baseline&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Change in Shortages from the Baseline&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_37_1.png" src="../_images/output_37_1.png" />
<p>We generally see the behavior we expect to see which is that with more
senior water rights, the user sees a decrease in shortage magnitude.</p>
<p>Now, continue on to Quickstarter Notebook #2 to learn how to use the
reservoir evaporation modification fuction.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: If you are interested in understanding how to apply
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions to your own model, take a look at the
source code found in the repository here:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/ddm.py&quot;</span><span class="o">&gt;</span><span class="n">modify_ddm</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/ddr.py&quot;</span><span class="o">&gt;</span><span class="n">modify_ddr</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="statemodify-quickstarter-notebook-2-using-the-eva-modification-function-in-the-gunnison-river-basin">
<h2><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #2 : Using the EVA Modification Function in the Gunnison River Basin<a class="headerlink" href="#statemodify-quickstarter-notebook-2-using-the-eva-modification-function-in-the-gunnison-river-basin" title="Link to this heading">#</a></h2>
<p>This notebook demonstrates the reservoir evaporation modification
function using the Gunnison River Basin as an example. Reservoir
evaporation is a pressing concern in the CRB. Lake Powell loses 0.86
million acre/ft per year to evaporation, which is over 6% of the flow
into the Colorado River and nearly the allocation to the state of Utah.
With warming temperatures driving aridification in the region,
evaporation will play an increasingly important role in shortages to
users.</p>
<section id="step-1-run-a-historical-simulation-in-statemod-for-the-gunnison-subbasin">
<h3>Step 1: Run a Historical Simulation in StateMod for the Gunnison Subbasin<a class="headerlink" href="#step-1-run-a-historical-simulation-in-statemod-for-the-gunnison-subbasin" title="Link to this heading">#</a></h3>
<p>To explore the importance of evaporation, we first we run baseline
simulation as we did in the first notebook, but this time, using the
dataset for the Gunnison.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import argparse
import logging
import os
import pickle
from string import Template
import subprocess

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import statemodify as stm
</pre></div>
</div>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: Each simulation in this notebook is run for the length of the
historical period (from 1909-2013). If you want to reduce the length
of the simulation, navigate to the <code class="docutils literal notranslate"><span class="pre">.ctl</span></code> file and adjust the
<code class="docutils literal notranslate"><span class="pre">iystr</span></code> and <code class="docutils literal notranslate"><span class="pre">iyend</span></code> variables. For this notebook, this file is
located in:
<code class="docutils literal notranslate"><span class="pre">data/gm2015_StateMod_modified/gm2015_StateMod_modified/StateMod/gm2015.ctl</span></code></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># statemod directory
statemod_dir = &quot;/usr/src/statemodify/statemod_gunnison_sjd&quot;

# root directory of statemod data for the target basin
root_dir = os.path.join(statemod_dir, &quot;src&quot;, &quot;main&quot;, &quot;fortran&quot;)

# home directory of notebook instance
home_dir = os.path.dirname(os.getcwd())

# path to the statemod executable
statemod_exe = os.path.join(root_dir, &quot;statemod-17.0.3-gfortran-lin-64bit-o3&quot;)

# data directory and root name for the target basin
data_dir = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;gm2015_StateMod_modified&quot;,
    &quot;gm2015_StateMod_modified&quot;,
    &quot;StateMod&quot;
)

# directory to the target basin input files with root name for the basin
basin_path = os.path.join(data_dir, &quot;gm2015B&quot;)

# scenarios output directory
scenarios_dir = os.path.join(data_dir, &quot;scenarios&quot;)

# path to eva template file
eva_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;gm2015B_template_eva.rsp&quot;
)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># run statemod
subprocess.call([statemod_exe, basin_path, &quot;-simulate&quot;])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">gm2015B</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">gm2015B</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">gm2015B</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
</pre></div>
</div>
<p>In this notebook, rather than acquiring user shortages which are found
in the <code class="docutils literal notranslate"><span class="pre">.xdd</span></code> output file, we can track reservoir storage which is
found in the
<code class="docutils literal notranslate"><span class="pre">`.xre</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/522/">https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/522/</a>&gt;`__
output file. Thus, in <code class="docutils literal notranslate"><span class="pre">statemodify</span></code>, we create a method that will
allow us to extract output from the <code class="docutils literal notranslate"><span class="pre">gm2015B.xre</span></code> file and save it as
a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file. Here we extract the shortages for Blue Mesa, one of the
most important upstream reservoirs in the Gunnison that is responsible
for supplying emergency water to Lake Powell.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># create a directory to store the historical reservoir levels at Blue Mesa
output_dir = os.path.join(data_dir, &quot;historic_reservoir_levels&quot;)

if not os.path.exists(output_dir):
    os.makedirs(output_dir)

# path the the xre file
xre_file = os.path.join(data_dir, &quot;gm2015B.xre&quot;)

# structure ID for reservoir of interest
structure_ID = &#39;6203532&#39;

# name of the reservoir
structure_name = &#39;Blue_Mesa&#39;

# extract the target info into a Pandas data frame
df = stm.extract_xre_data(structure_name=structure_name,
                          structure_id=structure_ID,
                          input_file=xre_file,
                          basin_name=None,
                          output_directory=output_dir,
                          write_csv=True,
                          write_parquet=None
)
</pre></div>
</div>
<p>We can then create an annual average from our extracted monthly
reservoir storage.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output_xre_file = os.path.join(output_dir, &quot;Blue_Mesa_xre_data.csv&quot;)

# read output data into a data frame
df = pd.read_csv(
    output_xre_file,
    usecols=[&#39;Year&#39;,&#39;Init. Storage&#39;],
    index_col=False)

# calculate the annual average
df = df.groupby(&#39;Year&#39;).mean().reset_index()

df
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Year</th>
      <th>Init. Storage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1908</td>
      <td>441516.500000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1909</td>
      <td>409705.807692</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1910</td>
      <td>378741.903846</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1911</td>
      <td>374242.865385</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1912</td>
      <td>402187.230769</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>101</th>
      <td>2009</td>
      <td>384270.711538</td>
    </tr>
    <tr>
      <th>102</th>
      <td>2010</td>
      <td>380057.192308</td>
    </tr>
    <tr>
      <th>103</th>
      <td>2011</td>
      <td>346074.019231</td>
    </tr>
    <tr>
      <th>104</th>
      <td>2012</td>
      <td>290796.692308</td>
    </tr>
    <tr>
      <th>105</th>
      <td>2013</td>
      <td>202086.125000</td>
    </tr>
  </tbody>
</table>
<p>106 rows × 2 columns</p>
</div><p>Finally, we can plot this annual average over time. We see swings in the
storage that correspond well with the earliest part of the streamflow
record that was relatively wet along with dry periods (large dips around
the 1930s dustbowl and 1950s drought and the severe early 2002 drought).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots()

plt.plot(df[&#39;Year&#39;], df[&#39;Init. Storage&#39;])

plt.title(&quot;Blue Mesa Storage&quot;)
plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Reservoir Storage (AF)&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Reservoir Storage (AF)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_13_1.png" src="../_images/output_13_1.png" />
</section>
<section id="step-2-modify-statemod-input-files-for-exploratory-analyses-evaporation-function-example">
<h3>Step 2: Modify StateMod Input Files for Exploratory Analyses- Evaporation Function Example<a class="headerlink" href="#step-2-modify-statemod-input-files-for-exploratory-analyses-evaporation-function-example" title="Link to this heading">#</a></h3>
<p>Now that we’ve run StateMod in baseline mode for the Gunnison, the next
step is to run it in exploratory analysis mode. To do this, we need to
create some plausible futures and adjust the input files for StateMod.
In this step, we’ll demonstrate Option 1 for <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> adjustments
using the <code class="docutils literal notranslate"><span class="pre">gm2015.eva</span></code> file as an example. Here we apply additives
rather than multipliers. As done in Hadjimichael et al. (2020), we
sample (using LHS) the change of evaporation between -15.24 and 30.46
cm/month (-0.5 to + 1 ft). The
<code class="docutils literal notranslate"><span class="pre">`.eva</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/415/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/415/</a>&gt;`__
file stores information for select larger reservoirs across all West
Slope basins. We choose the ID that corresponds to Blue Mesa (10011). We
create 2 alternative states of the world and store them in the
<code class="docutils literal notranslate"><span class="pre">input_files</span></code> directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># a dictionary to describe what you want to modify and the bounds for the Latin hypercube sample.
setup_dict = {
    &quot;ids&quot;: [&#39;10011&#39;],
    &quot;bounds&quot;: [-0.5, 1.0]
}

# create a directory to store the new files in if it does not exist
output_directory = os.path.join(data_dir, &quot;input_files&quot;)
if not os.path.exists(output_directory):
    os.makedirs(output_directory)

# scenario name
scenario = &quot;1&quot;

# the number of samples you wish to generate
n_samples = 2

# seed value for reproducibility if so desired
seed_value = 1

# number of rows to skip in file after comment
skip_rows = 1

# name of field to query
query_field = &quot;id&quot;

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = -1

# basin to process
basin_name = &quot;Gunnison&quot;

# generate a batch of files using generated LHS
stm.modify_eva(modify_dict=setup_dict,
               query_field=query_field,
               output_dir=output_directory,
               scenario=scenario,
               basin_name=basin_name,
               sampling_method=&quot;LHS&quot;,
               n_samples=n_samples,
               skip_rows=skip_rows,
               n_jobs=n_jobs,
               seed_value=seed_value,
               template_file=None,
               factor_method=&quot;add&quot;,
               data_specification_file=None,
               min_bound_value=-0.5,
               max_bound_value=1.0,
               save_sample=True)
</pre></div>
</div>
<p>If we print our two samples below, we see that we’ve created a state of
the world that has reduced evaporation (subtracting 0.18 ft) and one
with increased evaporation (adding 0.79 ft). These samples will be
termed SOW 1 and SOW 2 respectively.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># path to the numpy file containing the samples
eva_samples_file = os.path.join(output_directory, &quot;eva_2-samples_scenario-1.npy&quot;)

# load samples
sample_array = np.load(eva_samples_file)

sample_array
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.1872335</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.79024337</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="step-3-read-in-the-new-input-files-and-run-statemod-evaporation-example">
<h3>Step 3: Read in the New Input Files and Run StateMod : Evaporation Example<a class="headerlink" href="#step-3-read-in-the-new-input-files-and-run-statemod-evaporation-example" title="Link to this heading">#</a></h3>
<p>Now that we have created the input files, the next step is to run
StateMod with the new input files. We create a template <code class="docutils literal notranslate"><span class="pre">.rsp</span></code> file
(<code class="docutils literal notranslate"><span class="pre">gm2015B_template_eva.rsp</span></code>) and swap in the path to the alternative
<code class="docutils literal notranslate"><span class="pre">.eva</span></code> files that are created. Then we run StateMod for the two
scenarios and extract the reservoir levels for Blue Mesa.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 2, 1)

# read RSP template
with open(eva_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;EVA&quot;: f&quot;../../input_files/gm2015B_{scenario}.eva&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;gm2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = os.path.join(simulated_scenario_dir, f&quot;gm2015B_{scenario}&quot;)

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
 <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">gm2015B_S0_1</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">gm2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">gm2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios</span><span class="o">/</span><span class="n">S1_1</span><span class="o">/</span><span class="n">gm2015B_S1_1</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="step-4-visualize-reservoir-levels-in-new-sows">
<h3>Step 4: Visualize Reservoir Levels in New SOWs<a class="headerlink" href="#step-4-visualize-reservoir-levels-in-new-sows" title="Link to this heading">#</a></h3>
<p>Using <code class="docutils literal notranslate"><span class="pre">extract_xre_data()</span></code>, we can then extract the reservoir levels
at Blue Mesa in the two new SOWs.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># SOW 1
output_dir= os.path.join(scenarios_dir, &quot;S0_1&quot;)

# path the the xre file
xre_file = os.path.join(output_dir, &quot;gm2015B_S0_1.xre&quot;)

# structure ID for reservoir of interest
structure_ID = &#39;6203532&#39;

# name of the reservoir
structure_name = &#39;Blue_Mesa&#39;

# extract the target info into a Pandas data frame
df = stm.extract_xre_data(structure_name=structure_name,
                          structure_id=structure_ID,
                          input_file=xre_file,
                          basin_name=None,
                          output_directory=output_dir,
                          write_csv=True,
                          write_parquet=None
)

# SOW 2
output_dir= os.path.join(scenarios_dir, &quot;S1_1&quot;)

# path the the xre file
xre_file = os.path.join(output_dir, &quot;gm2015B_S1_1.xre&quot;)


# extract the target info into a Pandas data frame
df = stm.extract_xre_data(structure_name=structure_name,
                          structure_id=structure_ID,
                          input_file=xre_file,
                          basin_name=None,
                          output_directory=output_dir,
                          write_csv=True,
                          write_parquet=None
)
</pre></div>
</div>
<p>Finally, we can plot reservoir storage through time in our baseline
world and alternative states of the world.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># historic reservoir directory
historic_res_dir = os.path.join(data_dir, &quot;historic_reservoir_levels&quot;)
blue_mesa_file = os.path.join(historic_res_dir, &quot;Blue_Mesa_xre_data.csv&quot;)

# Import baseline dataframe
baseline = pd.read_csv(blue_mesa_file, index_col=False, usecols=[&#39;Year&#39;,&#39;Init. Storage&#39;])
baseline = baseline.groupby(&#39;Year&#39;).mean().reset_index()

# Import SOW1
s0_1_file = os.path.join(scenarios_dir, &quot;S0_1&quot;, &quot;Blue_Mesa_xre_data.csv&quot;)
SOW1 = pd.read_csv(s0_1_file, index_col=False, usecols=[&#39;Year&#39;,&#39;Init. Storage&#39;])
SOW1 = SOW1.groupby(&#39;Year&#39;).mean().reset_index()

# Import SOW2
s1_1_file = os.path.join(scenarios_dir, &quot;S1_1&quot;, &quot;Blue_Mesa_xre_data.csv&quot;)
SOW2 = pd.read_csv(s1_1_file, index_col=False, usecols=[&#39;Year&#39;,&#39;Init. Storage&#39;])
SOW2 = SOW2.groupby(&#39;Year&#39;).mean().reset_index()

# Plot reservoir levels
fig, ax = plt.subplots()

plt.plot(baseline[&#39;Year&#39;], baseline[&#39;Init. Storage&#39;],label=&#39;Baseline&#39;)
plt.plot(SOW1[&#39;Year&#39;], SOW1[&#39;Init. Storage&#39;],label=&#39;Reduced Evaporation&#39;)
plt.plot(SOW2[&#39;Year&#39;], SOW2[&#39;Init. Storage&#39;],label=&#39;Increased Evaporation&#39;)

plt.title(&quot;Blue Mesa Storage&quot;)
plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Reservoir Storage (AF)&quot;)

plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7faed3a29fc0</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_26_1.png" src="../_images/output_26_1.png" />
<p>We see that in SOW 1 (which corresponds to reduced evaporation), the
Blue Mesa storage is slightly higher than baseline. However, in SOW 2,
which corresponds to increased evaporation, we see that the reservoir
storage has reduced considerably.</p>
<p>We now encourage the user to explore how the changes in reservoir
storage impacts user shortages in Quickstarter Notebook #3.</p>
</section>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<p>Hadjimichael, A., Quinn, J., Wilson, E., Reed, P., Basdekas, L., Yates,
D., &amp; Garrison, M. (2020). Defining robustness, vulnerabilities, and
consequential scenarios for diverse stakeholder interests in
institutionally complex river basins. Earth’s Future, 8(7),
e2020EF001503.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: If you are interested in understanding how to apply
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions to your own model, take a look at the
source code found in the repository here:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/eva.py&quot;</span><span class="o">&gt;</span><span class="n">modify_eva</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="statemodify-quickstarter-notebook-3-using-the-res-modification-function-in-the-upper-colorado-river-basin">
<h2><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #3 : Using the RES Modification Function in the Upper Colorado River Basin<a class="headerlink" href="#statemodify-quickstarter-notebook-3-using-the-res-modification-function-in-the-upper-colorado-river-basin" title="Link to this heading">#</a></h2>
<p>This notebook demonstrates the reservoir storage modification function
in the Upper Colorado River Basin. In this notebook, we seek to
understand how changes to reservoir storage can impact user shortages.
First we run a baseline simulation, which runs the StateMod simulation
assuming that the current infrastructure has existed through the whole
simulation period. We next extract shortages for a municipality. Recall
that the list of users and their water rights can be found in the
<code class="docutils literal notranslate"><span class="pre">.ddr</span></code> file (located: <code class="docutils literal notranslate"><span class="pre">data/cm2015_StateMod/StateMod/cm2015.ddr</span></code>)</p>
<section id="step-1-run-a-historical-simulation-in-statemod-for-the-uppper-colorado-subbasin">
<h3>Step 1: Run a Historical Simulation in StateMod for the Uppper Colorado Subbasin<a class="headerlink" href="#step-1-run-a-historical-simulation-in-statemod-for-the-uppper-colorado-subbasin" title="Link to this heading">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import argparse
import logging
import os
import pickle
from string import Template
import subprocess

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import statemodify as stm
</pre></div>
</div>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: Each simulation in this notebook is run for the length of the
historical period (from 1909-2013). If you want to reduce the length
of the simulation, navigate to the <code class="docutils literal notranslate"><span class="pre">.ctl</span></code> file and adjust the
<code class="docutils literal notranslate"><span class="pre">iystr</span></code> and <code class="docutils literal notranslate"><span class="pre">iyend</span></code> variables. For this notebook, this file is
located in: <code class="docutils literal notranslate"><span class="pre">data/cm2015_StateMod/StateMod/cm2015.ctl</span></code></p>
</div>
<p>As before, we set the directories and associated paths and also run
StateMod in a baseline simulation.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># statemod directory
statemod_dir = &quot;/usr/src/statemodify/statemod_upper_co&quot;

# root directory of statemod data for the target basin
root_dir = os.path.join(statemod_dir, &quot;src&quot;, &quot;main&quot;, &quot;fortran&quot;)

# home directory of notebook instance
home_dir = os.path.dirname(os.getcwd())

# path to the statemod executable
statemod_exe = os.path.join(root_dir, &quot;statemod&quot;)

# data directory and root name for the target basin
data_dir = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;cm2015_StateMod&quot;,
    &quot;StateMod&quot;
)

# directory to the target basin input files with root name for the basin
basin_path = os.path.join(data_dir, &quot;cm2015B&quot;)

# scenarios output directory
scenarios_dir_res = os.path.join(data_dir, &quot;scenarios_res&quot;)

# parquet files output directory
parquet_dir_res = os.path.join(data_dir, &quot;parquet_res&quot;)


# path to res template file
res_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;cm2015B_template_res.rsp&quot;
)
</pre></div>
</div>
<div class="alert alert-block alert-info docutils container">
<p>NOTE In order to expedite simulations for the Upper Colorado dataset,
make sure to turn off “Reoperation” mode. You can do so by opening
<code class="docutils literal notranslate"><span class="pre">/home/jovyan/data/cm2015_StateMod/StateMod/cm2015.ctl</span></code>, navigating
to the <code class="docutils literal notranslate"><span class="pre">ireopx</span></code> entry and changing the value from “0” to “10”.</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Change directories first
os.chdir(data_dir) #This is needed specific to the Upper Colorado model as the path name is too long for the model to accept
subprocess.call([statemod_exe, &quot;cm2015B&quot;, &quot;-simulate&quot;])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">Parse</span><span class="p">;</span> <span class="n">Command</span> <span class="n">line</span> <span class="n">argument</span><span class="p">:</span>
   <span class="n">cm2015B</span> <span class="o">-</span><span class="n">simulate</span>
 <span class="n">________________________________________________________________________</span>

         <span class="n">StateMod</span>
         <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

         <span class="n">Version</span><span class="p">:</span> <span class="mf">15.00.01</span>
         <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2015</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">28</span>

 <span class="n">________________________________________________________________________</span>

   <span class="n">Opening</span> <span class="n">log</span> <span class="n">file</span> <span class="n">cm2015B</span><span class="o">.</span><span class="n">log</span>

   <span class="n">Subroutine</span> <span class="n">Execut</span>
   <span class="n">Subroutine</span> <span class="n">Datinp</span>

 <span class="o">...</span>

<span class="n">________________________________________________________________________</span>
   <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
   <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">cm2015B</span><span class="o">.</span><span class="n">log</span>
  <span class="n">Stop</span> <span class="mi">0</span>
</pre></div>
</div>
<p>We isolate the shortages for one municipal user: the Town of Brekenridge
at the base of the Rocky Mountains’ Tenmile Range (ID: 3601008). If we
look up this user in the <code class="docutils literal notranslate"><span class="pre">cm2015B.ddr</span></code> file, we see that the user has
median water rights (47483.00000) and a smaller decree of 2.90 cfs.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#Extract shortages using statemodify convert_xdd() function

# create a directory to store the historic shortages
output_dir = os.path.join(data_dir, &quot;historic_shortages&quot;)

# create a directory to store the new files in if it does not exist
output_directory = os.path.join(data_dir, &quot;historic_shortages&quot;)
if not os.path.exists(output_directory):
    os.makedirs(output_directory)

stm.xdd.convert_xdd(
    # path to a directory where output .parquet files should be written
    output_path=output_dir,
    # whether to abort if .parquet files already exist at the output_path
    allow_overwrite=True,
    # path, glob, or a list of paths/globs to the .xdd files you want to convert
    xdd_files=os.path.join(data_dir, &quot;*.xdd&quot;),
    # if the output .parquet files should only contain a subset of structure ids, list them here; None for all
    id_subset=[&#39;3601008&#39;],
    # how many .xdd files to convert in parallel; optimally you will want 2-4 CPUs per parallel process
    parallel_jobs=2,
    # convert to natural data types
    preserve_string_dtype=False

)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 17.73it/s]
</pre></div>
</div>
<p>Next we plot the shortages for Breckenridge.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data=pd.read_parquet(output_dir +&#39;/cm2015B.parquet&#39;,engine=&#39;pyarrow&#39;)

fig, ax = plt.subplots()

for name, group in data.groupby(&#39;structure_id&#39;):
    ax.scatter(
        group[&#39;year&#39;], group[&#39;shortage_total&#39;], label=name)

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.title(&quot;Baseline Shortages for Breckenridge&quot;)
plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7f44455974f0</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_12_1.png" src="../_images/output_12_1.png" />
<p>We see that Breckenridge has experienced a variety of shortages
throughout the baseline simulation period.</p>
</section>
<section id="step-2-modify-statemod-input-files-for-exploratory-analyses-reservoir-function-example">
<h3>Step 2: Modify StateMod Input Files for Exploratory Analyses- Reservoir Function Example<a class="headerlink" href="#step-2-modify-statemod-input-files-for-exploratory-analyses-reservoir-function-example" title="Link to this heading">#</a></h3>
<p>If we look at the <code class="docutils literal notranslate"><span class="pre">cm2015B.res</span></code> file (learn more about the
<code class="docutils literal notranslate"><span class="pre">`.res</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/411/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/411/</a>&gt;`__file),
we see that Breckenridge has an account in the Clinton Gulch Reservoir,
but a quick look in the
<code class="docutils literal notranslate"><span class="pre">`.opr</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/413/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/413/</a>&gt;`__
file also indicates that Breckenridge can receive water from the Dillon
reservoir. Let’s investigate what happens to these shortages when
storage at these two basins decreases using the <code class="docutils literal notranslate"><span class="pre">modify_res()</span></code>
function. As done in Hadjimichael et al. (2020), we sample losses using
a Latin hypercube sampling of up to 20% of the capacity of the
reservoirs (informed by Graf et al. (2010)) which may be due to erosion
and sedimentation of reservoirs in the UCRB, resulting in reduced
storage. The accounts associated with the reservoirs are also reduced
equally in order to accommodate the new storage level. For this example,
we want to change the reservoir storage for a specific set of reservoirs
by specifying the reservoir IDs for the <code class="docutils literal notranslate"><span class="pre">target_structure_id_list</span></code>.
However, by setting <code class="docutils literal notranslate"><span class="pre">target_structure_id_list=None</span></code> we can decrease
storage at all reservoirs in the basin.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output_directory = output_dir = os.path.join(data_dir, &quot;input_files&quot;)
scenario = &quot;1&quot;
# basin name to process
basin_name = &quot;Upper_Colorado&quot;

# seed value for reproducibility if so desired
seed_value = 1

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = 2

# number of samples to generate
n_samples = 1

stm.modify_res(output_dir=output_directory,
               scenario=scenario,
               basin_name=basin_name,
               target_structure_id_list=[&#39;3603575&#39;,&#39;3604512&#39;],
               seed_value=seed_value,
               n_jobs=n_jobs,
               n_samples=n_samples,
               save_sample=True)
</pre></div>
</div>
<p>Since we are sampling only reductions in storage, we can investigate
behavior with a single sample. We can then load the saved sample to see
the percent reduction in reservoir storage volume that has been applied
to the different reservoirs. The sample indicates that we are reducing
the reservoir storage volume to 86% of the original storage.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
sample_array = np.load(output_directory+&#39;/res_1-samples_scenario-1.npy&#39;)
sample_array
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.86911215</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="step-3-read-in-the-new-input-files-and-run-statemod-reservoir-example">
<h3>Step 3: Read in the New Input Files and Run StateMod : Reservoir Example<a class="headerlink" href="#step-3-read-in-the-new-input-files-and-run-statemod-reservoir-example" title="Link to this heading">#</a></h3>
<p>Now that we have created the input files, the next step is to run
StateMod with the new input files. We create a template <code class="docutils literal notranslate"><span class="pre">.rsp</span></code> file
(<code class="docutils literal notranslate"><span class="pre">cm2015B_template_res.rsp</span></code>) and swap in the path to the alternative
<code class="docutils literal notranslate"><span class="pre">.res</span></code> files that are created. Then we run StateMod for the two
scenarios and extract the shortages for Breckenridge.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 2, 1)

# read RSP template
with open(res_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;RES&quot;: f&quot;../../input_files/cm2015B_{scenario}.res&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir_res, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;cm2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = f&quot;cm2015B_{scenario}&quot;

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])

        #Save output to parquet files
        print(&#39;creating parquet for &#39; + scenario)

        output_directory = os.path.join(parquet_dir_res+&quot;/scenario/&quot;+ scenario)

        if not os.path.exists(output_directory):
            os.makedirs(output_directory)

        stm.xdd.convert_xdd(
            output_path=output_directory,
            allow_overwrite=True,
            xdd_files=scenarios_dir_res + &quot;/&quot;+ scenario + &quot;/cm2015B_&quot;+scenario+&quot;.xdd&quot;,
            id_subset=[&#39;3601008&#39;],
            parallel_jobs=2,
            preserve_string_dtype=False
        )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
  <span class="n">Parse</span><span class="p">;</span> <span class="n">Command</span> <span class="n">line</span> <span class="n">argument</span><span class="p">:</span>
  <span class="n">cm2015B_S0_1</span> <span class="o">-</span><span class="n">simulate</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span> <span class="mf">15.00.01</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2015</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">28</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Opening</span> <span class="n">log</span> <span class="n">file</span> <span class="n">cm2015B_S0_1</span><span class="o">.</span><span class="n">log</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">cm2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
<span class="n">creating</span> <span class="n">parquet</span> <span class="k">for</span> <span class="n">S0_1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 586.29it/s]
</pre></div>
</div>
<pre class="literal-block">Running: S1_1
  Parse; Command line argument:
  cm2015B_S1_1 -simulate
________________________________________________________________________

        StateMod
        State of Colorado - Water Supply Planning Model

        Version: 15.00.01
        Last revision date: 2015/10/28

________________________________________________________________________

  Opening log file cm2015B_S1_1.log

  Subroutine Execut
  Subroutine Datinp

________________________________________________________________________
  Datinp; Control File (<em>.ctl)

________________________________________________________________________
  Datinp; River Network File (</em>.rin)

________________________________________________________________________
  Datinp; Reservoir Station File (<em>.res)

________________________________________________________________________
  GetFile;  Stopped in GetFile, see the log file (</em>.log)
 Stop 1
creating parquet for S1_1</pre>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 589.42it/s]
</pre></div>
</div>
<p>Here, we extract the shortages from the Parquet files for the baseline
and alternative states of the world and plot the resulting shortages.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>baseline=pd.read_parquet(data_dir+&#39;/&#39;+&#39;historic_shortages/cm2015B.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_1=pd.read_parquet(parquet_dir_res+&#39;/scenario/S0_1/cm2015B_S0_1.parquet&#39;,engine=&#39;pyarrow&#39;)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>baseline[&quot;shortage_total&quot;]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">283920</span>      <span class="mf">0.</span>
<span class="mi">283921</span>      <span class="mf">0.</span>
<span class="mi">283922</span>      <span class="mf">0.</span>
<span class="mi">283923</span>    <span class="mf">220.</span>
<span class="mi">283924</span>    <span class="mf">201.</span>
          <span class="o">...</span>
<span class="mi">285280</span>      <span class="mf">0.</span>
<span class="mi">285281</span>      <span class="mf">0.</span>
<span class="mi">285282</span>      <span class="mf">0.</span>
<span class="mi">285283</span>      <span class="mf">0.</span>
<span class="mi">285284</span>      <span class="mf">0.</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">shortage_total</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">1365</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>baseline=pd.read_parquet(data_dir+&#39;/&#39;+&#39;historic_shortages/cm2015B.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_1=pd.read_parquet(parquet_dir_res+&#39;/scenario/S0_1/cm2015B_S0_1.parquet&#39;,engine=&#39;pyarrow&#39;)

#Subtract shortages with respect to the baseline
subset_df=pd.concat([baseline[&#39;year&#39;],baseline[&#39;shortage_total&#39;],SOW_1[&#39;shortage_total&#39;]],axis=1)
subset_df = subset_df.set_axis([&#39;Year&#39;, &#39;Baseline&#39;, &#39;SOW_1&#39;], axis=1)
subset_df[&#39;SOW_1_diff&#39;]=subset_df[&#39;SOW_1&#39;]-subset_df[&#39;Baseline&#39;]

#Plot shortages
fig, ax = plt.subplots()

ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;SOW_1_diff&#39;])

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.title(&quot;Change in Breckenridge Shortages from the Baseline&quot;)
plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">No</span> <span class="n">artists</span> <span class="k">with</span> <span class="n">labels</span> <span class="n">found</span> <span class="n">to</span> <span class="n">put</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span>  <span class="n">Note</span> <span class="n">that</span> <span class="n">artists</span> <span class="n">whose</span> <span class="n">label</span> <span class="n">start</span> <span class="k">with</span> <span class="n">an</span> <span class="n">underscore</span> <span class="n">are</span> <span class="n">ignored</span> <span class="n">when</span> <span class="n">legend</span><span class="p">()</span> <span class="ow">is</span> <span class="n">called</span> <span class="k">with</span> <span class="n">no</span> <span class="n">argument</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7f4434f250f0</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_25_2.png" src="../_images/output_25_2.png" />
<p>When we plot the shortages to Breckenridge under the alternative SOW
where reservoir storage is reduced across the two reservoirs, we can see
that there are now instances in which Breckenridge experiences larger
shortages than in the baseline case. Given that the town utilizes both
direct diversions and reservoir storage for water supply, this result
suggests that they have less of a bank of water to pull from in the two
reservoirs which increases shortages. However, there are even some cases
where the town experiences surpluses and many cases where the shortages
do not change, demonstrating that there is inherent complexity in the
mapping of reservoir level to shortages, especially when the user has
multiple reservoir accounts.</p>
<p>Now continue on to Quickstarter Notebook #4 to learn about running
StateMod with new streamflow scenarios across the West Slope basins.</p>
</section>
<section id="notebook-references">
<h3>Notebook References<a class="headerlink" href="#notebook-references" title="Link to this heading">#</a></h3>
<p>Graf, W. L., Wohl, E., Sinha, T., &amp; Sabo, J. L. (2010). Sedimentation
and sustainability of western American reservoirs. Water Resources
Research, 46, W12535. <a class="reference external" href="https://doi.org/10.1029/2009WR008836">https://doi.org/10.1029/2009WR008836</a></p>
<p>Hadjimichael, A., Quinn, J., Wilson, E., Reed, P., Basdekas, L., Yates,
D., &amp; Garrison, M. (2020). Defining robustness, vulnerabilities, and
consequential scenarios for diverse stakeholder interests in
institutionally complex river basins. Earth’s Future, 8(7),
e2020EF001503.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: If you are interested in understanding how to apply
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions to your own model, take a look at the
source code found in the repository here:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/res.py&quot;</span><span class="o">&gt;</span><span class="n">modify_res</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="statemodify-quickstarter-notebook-4-using-external-methods-to-generate-synthetic-streamflow-traces">
<h2><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #4: Using External Methods to Generate Synthetic Streamflow Traces<a class="headerlink" href="#statemodify-quickstarter-notebook-4-using-external-methods-to-generate-synthetic-streamflow-traces" title="Link to this heading">#</a></h2>
<p>In this notebook, we will demonstrate Option 2 that is provided by
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code>, which is the ability to create future states of the
world through external methods rather than manipulating the baseline
time series as we do in Option 1. Here we offer a method to generate
alternative streamflow time series for the five West Slope basins using
the <code class="docutils literal notranslate"><span class="pre">modify_xbm_iwr()</span></code> function.</p>
<p>The Colorado River Basin (CRB) is experiencing a shift to a more arid
climate which will likely be characterized by droughts that are longer
and more severe than what has been experienced historically. The
historic streamflow record is now not a sufficient representation of
future hydroclimate. Thus, we need methods of creating plausible future
streamflow scenarios for the region that can plausibly expand this
historic record.</p>
<p>In this notebook, we demonstrate how to use the multi-site Hidden Markov
model (HMM)-based synthetic streamflow generator in <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> to
create ensembles of plausible future regional streamflow traces for our
five West Slope basins. The HMM is fit to log annual historical
streamflow across the outlet gauges of five key basins on the West Slope
of the state of Colorado that drain into the Colorado River. The model
can then be used to generate streamflow scenarios that envelope the
historical record and expand the representation of natural variability
in the hydroclimate while still preserving the inter-site correlations
across the outlet gauges and at sites within each of the five basins.
The HMM-based model is particularly useful for generating sequences of
streamflow that exhibit long persistence, including decadal to
multidecadal hydrological drought conditions that are scarcely
represented within the historical records.</p>
<p>By fitting the HMM on the historical time series of the basins, we
create synthetic traces that are stationary and thus give an indication
of the extent of natural variability that characterizes the region. The
HMM can be extended to create non-stationary traces, as shown in
Hadjimichael et al. (2020), but that version of the model is not
currently included in <code class="docutils literal notranslate"><span class="pre">statemodify</span></code>.</p>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: Each simulation in this notebook is run for the length of the
historical period (from 1909-2013). If you want to reduce the length
of the simulation, navigate to the <code class="docutils literal notranslate"><span class="pre">.ctl</span></code> file and adjust the
<code class="docutils literal notranslate"><span class="pre">iystr</span></code> and <code class="docutils literal notranslate"><span class="pre">iyend</span></code> variables. For this notebook, this file is
located in: <code class="docutils literal notranslate"><span class="pre">data/cm2015_StateMod/StateMod/cm2015.ctl</span></code></p>
</div>
<section id="step-1-fit-multi-site-hmm">
<h3>Step 1: Fit Multi-Site HMM<a class="headerlink" href="#step-1-fit-multi-site-hmm" title="Link to this heading">#</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import argparse
import logging
import os
import pickle
from string import Template
import subprocess

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import statemodify as stm
</pre></div>
</div>
<p>First we define directories and associated paths.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># statemod directory
statemod_dir = &quot;/usr/src/statemodify/statemod_upper_co&quot;

# root directory of statemod data for the target basin
root_dir = os.path.join(statemod_dir, &quot;src&quot;, &quot;main&quot;, &quot;fortran&quot;)

# home directory of notebook instance
home_dir = os.path.dirname(os.getcwd())

# path to the statemod executable
statemod_exe = os.path.join(root_dir, &quot;statemod&quot;)

# data directory and root name for the target basin
data_dir = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;cm2015_StateMod&quot;,
    &quot;StateMod&quot;
)

# directory to the target basin input files with root name for the basin
basin_path = os.path.join(data_dir, &quot;cm2015B&quot;)

# scenarios output directory
scenarios_dir = os.path.join(data_dir, &quot;scenarios&quot;)

# path to iwr/xbm file
xbm_iwr_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;cm2015B_template_xbm_iwr.rsp&quot;
)
</pre></div>
</div>
<p>We create a function <code class="docutils literal notranslate"><span class="pre">hmm_multisite_fit()</span></code> that houses the Python code
to fit the multi-site HMM to annual flow at the outlet gauges of the
five basins. In this function, you can specify the output directory to
store the HMM parameters.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#Make directory to store HMM parameters

output_dir = os.path.join(data_dir, &quot;HMM_parameters&quot;)

if not os.path.exists(output_dir):
    os.makedirs(output_dir)

n_basins = 5

# choice to save parameters to NumPy array files
save_parameters = True

fit_array_dict = stm.hmm_multisite_fit(n_basins=n_basins,
                                       save_parameters=save_parameters,
                                       output_directory=output_dir)

# unpack output dictionary
unconditional_dry = fit_array_dict[&quot;unconditional_dry&quot;]
unconditional_wet = fit_array_dict[&quot;unconditional_wet&quot;]
logAnnualQ_h = fit_array_dict[&quot;logAnnualQ_h&quot;]
transition_matrix = fit_array_dict[&quot;transition_matrix&quot;]
covariance_matrix_wet = fit_array_dict[&quot;covariance_matrix_wet&quot;]
covariance_matrix_dry = fit_array_dict[&quot;covariance_matrix_dry&quot;]
wet_state_means = fit_array_dict[&quot;wet_state_means&quot;]
dry_state_means = fit_array_dict[&quot;dry_state_means&quot;]
</pre></div>
</div>
</section>
<section id="step-2-sample-from-multi-site-hmm">
<h3>Step 2: Sample from multi-site HMM<a class="headerlink" href="#step-2-sample-from-multi-site-hmm" title="Link to this heading">#</a></h3>
<p>We then use the <code class="docutils literal notranslate"><span class="pre">hmm_multisite_sample()</span></code> function to sample from the
HMM 100 times to develop 100 alternative, 105-year traces of streamflow
at the outlet gauge of each basin and we save each trace in a .csv file
in the <code class="docutils literal notranslate"><span class="pre">HMM_Runs</span></code> folder.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#Create a folder to store the runs

output_dir = os.path.join(data_dir, &quot;HMM_Runs&quot;)

if not os.path.exists(output_dir):
    os.makedirs(output_dir)

# using the outputs of the fit function above; this function write output sample files to the output directory
stm.hmm_multisite_sample(logAnnualQ_h,
                         transition_matrix,
                         unconditional_dry,
                         dry_state_means,
                         wet_state_means,
                         covariance_matrix_dry,
                         covariance_matrix_wet,
                         n_basins=n_basins,
                         output_directory=output_dir)
</pre></div>
</div>
<p>Then one can plot flow duration curves (FDCs) of the annual
synthetically generated flow at each basin compared to the the
historical record. We see that the HMM is enveloping the historical
record and also expanding it around it, particularly around the tails of
the distribution, which will lead to more instances of extreme flood and
drought events.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>stm.plot_flow_duration_curves(flow_realizations_directory=output_dir,
                              save_figure=True,output_directory=output_dir,
                              figure_name= &#39;FDC&#39;,
                              dpi= 300)
</pre></div>
</div>
<img alt="../_images/output_15_0.png" src="../_images/output_15_0.png" />
</section>
<section id="step-3-modify-statemod-input-files-for-exploratory-analyses-streamflow-example">
<h3>Step 3: Modify StateMod Input Files for Exploratory Analyses- Streamflow Example<a class="headerlink" href="#step-3-modify-statemod-input-files-for-exploratory-analyses-streamflow-example" title="Link to this heading">#</a></h3>
<p>In order for the HMM to be used in conjunction with StateMod, we utilize
a statistical disaggregation technique to disaggregate the synthetically
generated outlet gauge flow to the upstream nodes and also from an
annual to monthly time scale. The synthetic log-space annual flows are
converted to real space and temporally downscaled to monthly flows using
a modification of the proportional scaling method used by Nowak et
al. (2010). First, a historical year is probabilistically selected based
on its “nearness” to the synthetic flow at the last node in terms of
annual total. The shifted monthly flows at the last node are then
downscaled to all other nodes using the same ratios of monthly flows at
the upstream nodes to the last node as in the historically selected
year.Though not demonstrated in this notebook, the irrigation demands
(in the
<code class="docutils literal notranslate"><span class="pre">`.iwr</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/41/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/41/</a>&gt;`__
file) are also inherently tied to the generation of the streamflow, as
irrigation demands will increase in dry years. Thus, a regression is fit
across historical irrigation anomalies and historical annual flow
anomalies and the appropriate irrigation anomaly is determined from this
regression for every synthetically generated flow anomaly. More
information on this method can be found in Hadjimichael et al., 2020.
All of this functionality is embedded in the <code class="docutils literal notranslate"><span class="pre">modify_xbm_iwr()</span></code>
function.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#Make directory to store input files

output_dir = os.path.join(data_dir, &quot;input_files&quot;)

if not os.path.exists(output_dir):
    os.makedirs(output_dir)


flow_realizations_directory = os.path.join(data_dir, &quot;HMM_Runs&quot;)

scenario = &quot;1&quot;

# basin name to process
basin_name = &quot;Upper_Colorado&quot;

# seed value for reproducibility if so desired
seed_value = 123

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = 2

# number of samples to generate (how many new xbm and iwr files); produces an IWR multiplier
n_samples = 1

# generate a batch of files using generated LHS
stm.modify_xbm_iwr(output_dir=output_dir,
                   flow_realizations_directory=flow_realizations_directory,
                   scenario=scenario,
                   basin_name=basin_name,
                   seed_value=seed_value,
                   n_jobs=n_jobs,
                   n_samples=n_samples,
                   save_sample=True,
                   randomly_select_flow_sample=True)
</pre></div>
</div>
</section>
<section id="step-4-read-in-the-new-input-files-and-run-statemod-streamflow-example">
<h3>Step 4: Read in the New Input Files and Run StateMod : Streamflow Example<a class="headerlink" href="#step-4-read-in-the-new-input-files-and-run-statemod-streamflow-example" title="Link to this heading">#</a></h3>
<p>Now that we have created the new files, the next step is to run them
through StateMod. We create a template <code class="docutils literal notranslate"><span class="pre">.rsp</span></code> file
(<code class="docutils literal notranslate"><span class="pre">cm2015B_template_xbm_iwr.rsp</span></code>) and swap in the path to the
alternative
<code class="docutils literal notranslate"><span class="pre">`.xbm</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/513/">https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/513/</a>&gt;`__
and <code class="docutils literal notranslate"><span class="pre">.iwr</span></code> files that are created. Then we run StateMod for the single
scenario and one can then go on and extract shortages or reservoir
levels.</p>
<div class="alert alert-block alert-info docutils container">
<p>NOTE In order to expedite simulations for the Upper Colorado dataset,
make sure to turn off “Reoperation” mode. You can do so by opening
<code class="docutils literal notranslate"><span class="pre">/home/jovyan/data/cm2015_StateMod/StateMod/cm2015.ctl</span></code>, navigating
to the <code class="docutils literal notranslate"><span class="pre">ireopx</span></code> entry and changing the value from “0” to “10”.</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 1, 1)

# read RSP template
with open(xbm_iwr_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;XBM&quot;: f&quot;../../input_files/cm2015B_{scenario}.xbm&quot;,&quot;IWR&quot;: f&quot;../../input_files/cm2015B_{scenario}.iwr&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;cm2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = f&quot;cm2015B_{scenario}&quot;

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
     <span class="n">Parse</span><span class="p">;</span> <span class="n">Command</span> <span class="n">line</span> <span class="n">argument</span><span class="p">:</span>
     <span class="n">cm2015B_S0_1</span> <span class="o">-</span><span class="n">simulate</span>
   <span class="n">________________________________________________________________________</span>

           <span class="n">StateMod</span>
           <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

           <span class="n">Version</span><span class="p">:</span> <span class="mf">15.00.01</span>
           <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2015</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">28</span>

   <span class="n">________________________________________________________________________</span>

     <span class="n">Opening</span> <span class="n">log</span> <span class="n">file</span> <span class="n">cm2015B_S0_1</span><span class="o">.</span><span class="n">log</span>

     <span class="n">Subroutine</span> <span class="n">Execut</span>
     <span class="n">Subroutine</span> <span class="n">Datinp</span>

   <span class="o">...</span>

<span class="n">________________________________________________________________________</span>
     <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
     <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">cm2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
    <span class="n">Stop</span> <span class="mi">0</span>
</pre></div>
</div>
<p>It’s easiest to see the value of generating multiple streamflow
scenarios if we run 100-1000 scenarios through StateMod. However, this
container does not have the resources to support exploratory modeling at
this scale. So we run these simulations externally and below, we read in
the <code class="docutils literal notranslate"><span class="pre">.xre</span></code> files with the <code class="docutils literal notranslate"><span class="pre">read_xre()</span></code> helper function and show the
distribution of the reservoir levels that are observed across Lake
Granby in the Upper Colorado under the 100 simulated scenarios versus
the historical 105-year period.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Example with Granby Lake
zip_file_path = os.path.join(home_dir, &#39;data&#39;, &#39;Granby_Dataset.zip&#39;)
final_directory = os.path.join(home_dir, &#39;data/&#39;)

!unzip $zip_file_path -d $final_directory
granby_hmm, granby_hist, granby_hist_mean, granby_hist_1p = stm.read_xre(os.path.join(home_dir,&quot;data/Upper_Colorado/&quot;), &#39;Granby&#39;)

# Plot quantiles
stm.plot_res_quantiles(granby_hmm, granby_hist_mean, &#39;Lake Granby&#39;)
</pre></div>
</div>
<img alt="../_images/output_24_0.png" src="../_images/output_24_0.png" />
<p>Here, we plot the monthly reservoir storage quantiles across each month
of the year. The shading corresponds to the larger 100-member sample
from the HMM and the dotted black line corresponds to the monthly
average storage across the historical 105-year record. Importantly, the
HMM is expanding the distribution of reservoir storages, particularly
creating both larger and smaller storages, meaning that we are capturing
reservoir levels under a broader range of wetter and drier conditions
that could have implications for shortages for users.</p>
<p>We can also plot the range of monthly storages from the HMM and
historical period as box plots for an alternative comparison using the
<code class="docutils literal notranslate"><span class="pre">plot_reservoir_boxes()</span></code> helper function.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># using the output of the above `read_xre` function as inputs
stm.plot_reservoir_boxes(granby_hmm, granby_hist, &#39;Lake Granby&#39;)
</pre></div>
</div>
<img alt="../_images/output_27_0.png" src="../_images/output_27_0.png" />
<p>Here, the blue box plots correspond to the HMM-generated reservoir
storages and the orange box plots correspond to the historical monthly
dataset. The black circles represent outliers. As illustrated in the
quantile plot above as well, for all months, the HMM is creating a wider
distribution of reservoir storages, and tends to be able to encompass
even historical outliers. Remember that the HMM has only been fit on the
historical dataset. Thus, the HMM can provide an estimate of the expanse
of reservoir storages that can be expected just within the range of
natural variability, which is quite large! Particularly, the HMM is
creating many more instances of drier scenarios and lower reservoir
levels which can be very useful for informing drought vulnerability
assessments.</p>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: If you are curious to learn more about HMM-based synthetic
streamflow generation, including model fitting, validation, and
applications, please refer to the following resources:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://waterprogramming.wordpress.com/2018/07/03/fitting-hidden-markov-models-part-i-background-and-methods/&quot;</span><span class="o">&gt;</span><span class="n">Fitting</span> <span class="n">Hidden</span> <span class="n">Markov</span> <span class="n">Models</span><span class="p">:</span> <span class="n">Background</span> <span class="ow">and</span> <span class="n">Methods</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://waterprogramming.wordpress.com/2018/07/03/fitting-hidden-markov-models-part-ii-sample-python-script/&quot;</span><span class="o">&gt;</span><span class="n">Fitting</span> <span class="n">Hidden</span> <span class="n">Markov</span> <span class="n">Models</span><span class="p">:</span> <span class="n">Sample</span> <span class="n">Scripts</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">3.</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://uc-ebook.org/docs/html/A2_Jupyter_Notebooks.html#a-hidden-markov-modeling-approach-to-creating-synthetic-streamflow-scenarios-tutorial&quot;</span><span class="o">&gt;</span><span class="n">A</span> <span class="n">Hidden</span><span class="o">-</span><span class="n">Markov</span> <span class="n">Modeling</span> <span class="n">Approach</span> <span class="n">to</span> <span class="n">Creating</span> <span class="n">Synthetic</span> <span class="n">Streamflow</span> <span class="n">Scenarios</span> <span class="n">Tutorial</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="notebook-specific-references">
<h3>Notebook Specific References<a class="headerlink" href="#notebook-specific-references" title="Link to this heading">#</a></h3>
<p>Nowak, K., Prairie, J., Rajagopalan, B., &amp; Lall, U. (2010). A
nonparametric stochastic approach for multisite disaggregation of annual
to daily streamflow. Water resources research, 46(8).</p>
<p>Hadjimichael, A., Quinn, J., Wilson, E., Reed, P., Basdekas, L., Yates,
D., &amp; Garrison, M. (2020). Defining robustness, vulnerabilities, and
consequential scenarios for diverse stakeholder interests in
institutionally complex river basins. Earth’s Future, 8(7),
e2020EF001503.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: If you are interested in understanding how to apply
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions to your own model, take a look at the
source code found in the repository here:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/xbm_iwr.py&quot;</span><span class="o">&gt;</span><span class="n">modify_xbm_iwr</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="statemodify-quickstarter-notebook-5-sampling-multiple-uncertainties">
<h2><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #5 : Sampling Multiple Uncertainties<a class="headerlink" href="#statemodify-quickstarter-notebook-5-sampling-multiple-uncertainties" title="Link to this heading">#</a></h2>
<p>In the prior notebooks, we sampled just one type of uncertainty at a
time to demonstrate how a single adjustment in the selected input file
leads to a verifiable change in output so that we can demonstrate that
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> is working as expected. It is much harder to make sense
of the relative importance of uncertain drivers unless we conduct a
formal sensitivity analysis, which lies outside of the bounds of this
tutorial. However, it is very likely that many of these uncertainties
will be present and of interest in any given future for the region.
Thus, this notebook is used to demonstrate how to do a Latin hypercube
sample simultaneously across multiple uncertainties in a given basin
using the <code class="docutils literal notranslate"><span class="pre">modify_batch()</span></code> function.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import argparse
import logging
import os
import pickle
from string import Template
import subprocess

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import statemodify as stm
</pre></div>
</div>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: Each simulation in this notebook is run for the length of the
historical period (from 1909-2013). If you want to reduce the length
of the simulation, navigate to the <code class="docutils literal notranslate"><span class="pre">.ctl</span></code> file and adjust the
<code class="docutils literal notranslate"><span class="pre">iystr</span></code> and <code class="docutils literal notranslate"><span class="pre">iyend</span></code> variables. For this notebook, this file is
located in: <code class="docutils literal notranslate"><span class="pre">data/cm2015_StateMod/StateMod/cm2015.ctl</span></code></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># statemod directory
statemod_dir = &quot;/usr/src/statemodify/statemod_upper_co&quot;

# root directory of statemod data for the target basin
root_dir = os.path.join(statemod_dir, &quot;src&quot;, &quot;main&quot;, &quot;fortran&quot;)

# home directory of notebook instance
home_dir = os.path.dirname(os.getcwd())

# path to the statemod executable
statemod_exe = os.path.join(root_dir, &quot;statemod&quot;)

# data directory and root name for the target basin
data_dir = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;cm2015_StateMod&quot;,
    &quot;StateMod&quot;
)

# directory to the target basin input files with root name for the basin
basin_path = os.path.join(data_dir, &quot;cm2015B&quot;)

# scenarios output directory
scenarios_dir = os.path.join(data_dir, &quot;scenarios&quot;)

#parquet output directory
parquet_dir=os.path.join(data_dir, &quot;parquet&quot;)


# path to template file
multi_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;cm2015B_template_multi.rsp&quot;
)
</pre></div>
</div>
<section id="step-1-creating-a-sample-across-multiple-uncertainties">
<h3>Step 1: Creating a Sample Across Multiple Uncertainties<a class="headerlink" href="#step-1-creating-a-sample-across-multiple-uncertainties" title="Link to this heading">#</a></h3>
<p>In this example, we create a global Latin hypercube sample across 3
example uncertainties that we are interested in for the Upper Colorado:
evaporation at reservoirs, modification of water rights, and demands.
The form of the <code class="docutils literal notranslate"><span class="pre">modify_batch()</span></code> function is similiar to those
presented in the last notebooks; however, now, a problem dictionary
stores the names of the respective <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions
(<code class="docutils literal notranslate"><span class="pre">modify_eva</span></code>, <code class="docutils literal notranslate"><span class="pre">modify_ddr</span></code>, <code class="docutils literal notranslate"><span class="pre">modify_ddm</span></code>) that will now be
applied simultaneously. The Latin hypercube sample is conducted with
respect to the <code class="docutils literal notranslate"><span class="pre">bounds</span></code> listed and the resulting multipliers or
additives are applied to the target IDs listed.</p>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: If you are interested in creating an alternative <code class="docutils literal notranslate"><span class="pre">.ddr</span></code> file
that does not sample decrees, only adjusts the water rights, then you
will need to write <code class="docutils literal notranslate"><span class="pre">None</span></code> in the “bounds” parameter as we do below.
If you include bounds, then decrees as well as water rights will be
adjusted simultaneously.</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import statemodify as stm

# variables that apply to multiple functions
output_dir = os.path.join(data_dir, &quot;input_files&quot;)
basin_name = &quot;Upper_Colorado&quot;
scenario = &quot;1&quot;
seed_value = 77

# problem dictionary
problem_dict = {
    &quot;n_samples&quot;: 1,
    &#39;num_vars&#39;: 3,
    &#39;names&#39;: [&#39;modify_eva&#39;, &#39;modify_ddr&#39;, &#39;modify_ddm&#39;],
    &#39;bounds&#39;: [
        [-0.5, 1.0],
        None,
        [0.5, 1.0]
    ],
    # additional settings for each function
    &quot;modify_eva&quot;: {
        &quot;seed_value&quot;: seed_value,
        &quot;output_dir&quot;: output_dir,
        &quot;scenario&quot;: scenario,
        &quot;basin_name&quot;: basin_name,
        &quot;query_field&quot;: &quot;id&quot;,
        &quot;ids&quot;: [&quot;10008&quot;, &quot;10009&quot;]
    },
    &quot;modify_ddr&quot;: {
        &quot;seed_value&quot;: seed_value,
        &quot;output_dir&quot;: output_dir,
        &quot;scenario&quot;: scenario,
        &quot;basin_name&quot;: basin_name,
        &quot;query_field&quot;: &quot;id&quot;,
        &quot;ids&quot;: [&quot;3600507.01&quot;, &quot;3600507.02&quot;],
        &quot;admin&quot;: [1, None],
        &quot;on_off&quot;: [1, 1]
    },
    &quot;modify_ddm&quot;: {
        &quot;seed_value&quot;: seed_value,
        &quot;output_dir&quot;: output_dir,
        &quot;scenario&quot;: scenario,
        &quot;basin_name&quot;: basin_name,
        &quot;query_field&quot;: &quot;id&quot;,
        &quot;ids&quot;: [&quot;3600507&quot;, &quot;3600603&quot;]
    }
}

# run in batch
fn_parameter_dict = stm.modify_batch(problem_dict=problem_dict)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">modify_eva</span>
<span class="n">Running</span> <span class="n">modify_ddr</span>
<span class="n">Running</span> <span class="n">modify_ddm</span>
</pre></div>
</div>
</section>
<section id="step-2-running-a-simulation">
<h3>Step 2: Running a Simulation<a class="headerlink" href="#step-2-running-a-simulation" title="Link to this heading">#</a></h3>
<p>Now that we have developed the samples, we need to adjust our template
file to take in the additional uncertainties and then we can run our
simulation! Note that in contrast to the other notebooks, we are
changing the “EVA”, “DDM”, and “DDR” entries in the <code class="docutils literal notranslate"><span class="pre">.rsp</span></code> file at the
same time, running the simulation, and then extracting the shortages for
a specific user (ID: 3601008).</p>
<div class="alert alert-block alert-info docutils container">
<p>NOTE In order to expedite simulations for the Upper Colorado dataset,
make sure to turn off “Reoperation” mode. You can do so by opening
<code class="docutils literal notranslate"><span class="pre">/home/jovyan/data/cm2015_StateMod/StateMod/cm2015.ctl</span></code>, navigating
to the <code class="docutils literal notranslate"><span class="pre">ireopx</span></code> entry and changing the value from “0” to “10”.</p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 1, 1)

# read RSP template
with open(multi_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;EVA&quot;: f&quot;../../input_files/cm2015B_{scenario}.eva&quot;,&quot;DDM&quot;: f&quot;../../input_files/cm2015B_{scenario}.ddm&quot;,&quot;DDR&quot;: f&quot;../../input_files/cm2015B_{scenario}.ddr&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;cm2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = f&quot;cm2015B_{scenario}&quot;

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])

        #Save output to parquet files
        print(&#39;creating parquet for &#39; + scenario)

        output_directory = os.path.join(parquet_dir+ &quot;/scenario/&quot;+ scenario)

        if not os.path.exists(output_directory):
            os.makedirs(output_directory)

        stm.xdd.convert_xdd(output_path=output_directory,allow_overwrite=False,xdd_files=scenarios_dir + &quot;/&quot;+ scenario + &quot;/cm2015B_&quot;+scenario+&quot;.xdd&quot;,id_subset=[&#39;3601008&#39;],parallel_jobs=2)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
  <span class="n">Parse</span><span class="p">;</span> <span class="n">Command</span> <span class="n">line</span> <span class="n">argument</span><span class="p">:</span>
  <span class="n">cm2015B_S0_1</span> <span class="o">-</span><span class="n">simulate</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span> <span class="mf">15.00.01</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2015</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">28</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Opening</span> <span class="n">log</span> <span class="n">file</span> <span class="n">cm2015B_S0_1</span><span class="o">.</span><span class="n">log</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>
</pre></div>
</div>
<p>At the end of the simulation, the output is the file,
<code class="docutils literal notranslate"><span class="pre">cm2015B_S0_1.parquet</span></code>, which now contains the shortages for the
target ID for the length of the simulation. The user can then proceed to
do similiar analyses on water shortages that have been demonstrated in
the prior notebooks.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: If you are interested in understanding how to apply
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions to your own model, take a look at the
source code found in the repository here:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/batch.py&quot;</span><span class="o">&gt;</span><span class="n">modify_batch</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="installation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Installation</p>
      </div>
    </a>
    <a class="right-next"
       href="useful_links.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Useful Links</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-1-getting-started-and-using-the-ddm-and-ddr-modification-functions-in-the-san-juan-river-basin"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #1: Getting Started and Using the DDM and DDR Modification Functions in the San Juan River Basin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin">Step 1: Run a Historical Simulation in StateMod for the San Juan Basin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example">Step 2a: Modify StateMod Input Files for Exploratory Analyses- Demand Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example">Step 2b: Read in the New Input Files and Run StateMod : Demand Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2c-visualize-shortages-in-new-sows-demand-function-example">Step 2c: Visualize Shortages in New SOWs- Demand Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example">Step 3a: Modify StateMod Input Files for Exploratory Analyses- Water Rights Function Example</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-2-using-the-eva-modification-function-in-the-gunnison-river-basin"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #2 : Using the EVA Modification Function in the Gunnison River Basin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-gunnison-subbasin">Step 1: Run a Historical Simulation in StateMod for the Gunnison Subbasin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-modify-statemod-input-files-for-exploratory-analyses-evaporation-function-example">Step 2: Modify StateMod Input Files for Exploratory Analyses- Evaporation Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-read-in-the-new-input-files-and-run-statemod-evaporation-example">Step 3: Read in the New Input Files and Run StateMod : Evaporation Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-visualize-reservoir-levels-in-new-sows">Step 4: Visualize Reservoir Levels in New SOWs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-3-using-the-res-modification-function-in-the-upper-colorado-river-basin"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #3 : Using the RES Modification Function in the Upper Colorado River Basin</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-uppper-colorado-subbasin">Step 1: Run a Historical Simulation in StateMod for the Uppper Colorado Subbasin</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-modify-statemod-input-files-for-exploratory-analyses-reservoir-function-example">Step 2: Modify StateMod Input Files for Exploratory Analyses- Reservoir Function Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-read-in-the-new-input-files-and-run-statemod-reservoir-example">Step 3: Read in the New Input Files and Run StateMod : Reservoir Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-references">Notebook References</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-4-using-external-methods-to-generate-synthetic-streamflow-traces"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #4: Using External Methods to Generate Synthetic Streamflow Traces</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-fit-multi-site-hmm">Step 1: Fit Multi-Site HMM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-sample-from-multi-site-hmm">Step 2: Sample from multi-site HMM</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-modify-statemod-input-files-for-exploratory-analyses-streamflow-example">Step 3: Modify StateMod Input Files for Exploratory Analyses- Streamflow Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-read-in-the-new-input-files-and-run-statemod-streamflow-example">Step 4: Read in the New Input Files and Run StateMod : Streamflow Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-specific-references">Notebook Specific References</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statemodify-quickstarter-notebook-5-sampling-multiple-uncertainties"><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #5 : Sampling Multiple Uncertainties</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-creating-a-sample-across-multiple-uncertainties">Step 1: Creating a Sample Across Multiple Uncertainties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-running-a-simulation">Step 2: Running a Simulation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Rohini S. Gupta
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, Battelle Memorial Institute.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>