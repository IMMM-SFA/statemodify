
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>statemodify Quickstarter Notebook #1: Getting Started and Using the DDM and DDR Modification Functions in the San Juan River Basin &#8212; statemodify documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=f6d3da1f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=a5fa425f"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/N1_Demand_WaterRights_File_Modification';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_statemodify.png" class="logo__image only-light" alt="statemodify documentation - Home"/>
    <script>document.write(`<img src="../_static/logo_statemodify.png" class="logo__image only-dark" alt="statemodify documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/quickstarter.html">Quickstarter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/useful_links.html">Useful Links</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/api.html">Python API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reference/contributing.html">Contributing to <strong>statemodify</strong></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/IMMM-SFA/statemodify" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/IMMM-SFA/statemodify/edit/main/docs/source/notebooks/N1_Demand_WaterRights_File_Modification.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/IMMM-SFA/statemodify/issues/new?title=Issue%20on%20page%20%2Fnotebooks/N1_Demand_WaterRights_File_Modification.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/N1_Demand_WaterRights_File_Modification.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>statemodify Quickstarter Notebook #1: Getting Started and Using the DDM and DDR Modification Functions in the San Juan River Basin</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin">Step 1: Run a Historical Simulation in StateMod for the San Juan Basin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example">Step 2a: Modify StateMod Input Files for Exploratory Analyses- Demand Function Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example">Step 2b: Read in the New Input Files and Run StateMod : Demand Function Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2c-visualize-shortages-in-new-sows-demand-function-example">Step 2c: Visualize Shortages in New SOWs- Demand Function Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example">Step 3a: Modify StateMod Input Files for Exploratory Analyses- Water Rights Function Example</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="statemodify-quickstarter-notebook-1-getting-started-and-using-the-ddm-and-ddr-modification-functions-in-the-san-juan-river-basin">
<h1><code class="docutils literal notranslate"><span class="pre">statemodify</span></code> Quickstarter Notebook #1: Getting Started and Using the DDM and DDR Modification Functions in the San Juan River Basin<a class="headerlink" href="#statemodify-quickstarter-notebook-1-getting-started-and-using-the-ddm-and-ddr-modification-functions-in-the-san-juan-river-basin" title="Link to this heading">#</a></h1>
<p>In this series of five notebooks, we demonstrate the functionality of
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> using three of the five subbasins on the West Slope
basin in the state of Colorado: Gunnison, San Juan/Dolores, and the
Upper Colorado Basin. There are two classes of adjustments offered in
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> that can be used to create alternative future states of
the world for the region:</p>
<ol class="arabic simple">
<li><p>Application of multipliers or additives to the original dataset which
are sampled from specified bounds using a Latin hypercube sample</p></li>
<li><p>Complete swap of input data with data generated from an external
method</p></li>
</ol>
<p>Option 1 is applicable to <code class="docutils literal notranslate"><span class="pre">.ddm</span></code> (monthly demand), <code class="docutils literal notranslate"><span class="pre">.ddr</span></code> (water
rights), <code class="docutils literal notranslate"><span class="pre">.eva</span></code> (reservoir evaporation), <code class="docutils literal notranslate"><span class="pre">.res</span></code> (reservoir storage).</p>
<p>Option 2 is applicable to <code class="docutils literal notranslate"><span class="pre">.xbm</span></code> (monthly streamflow) and <code class="docutils literal notranslate"><span class="pre">.iwr</span></code>
(irrigation demand). In <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> we provide a Hidden Markov Model
(HMM)-based approach to generate synthetic flows across the basins and
tie in irrigation demand to be negatively correlated to increased
streamflow.</p>
<p>In this first notebook, we will demonstrate now to use the demand
(<code class="docutils literal notranslate"><span class="pre">modify_ddm()</span></code>)and water rights (<code class="docutils literal notranslate"><span class="pre">modify_ddr()</span></code>) modification
functions in the San Juan River Basin. Demands are projected to increase
with the growth of cities and agriculture and water rights will likely
change as discussions on changes to the Colorado Compact and
re-allocation of water across the Colorado River Basin to promote
sustainable development continue.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: When each StateMod file is mentioned, clicking on the name will
link the user to the StateMod documentation with more information on
that file.</p>
</div>
<section id="step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin">
<h2>Step 1: Run a Historical Simulation in StateMod for the San Juan Basin<a class="headerlink" href="#step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin" title="Link to this heading">#</a></h2>
<p>Before we start on an exploratory modeling journey, you may be first
interested in understanding water shortages that the basin has
historically experienced. In the container, we have downloaded and
compiled StateMod, <code class="docutils literal notranslate"><span class="pre">statemodify</span></code>, and the San Juan dataset from the
Colorado’s Decision Support System (CDSS) website. We can run a baseline
simulation below which takes approximately 4 minutes. In this baseline
simulation, we run StateMod over the length of the historical period
(105 years) under the assumption that we are starting from current
conditions.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import argparse
import logging
import os
import pickle
from string import Template
import subprocess

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import statemodify as stm
</pre></div>
</div>
<div class="alert alert-block alert-info docutils container">
<p>NOTE: Each simulation in this notebook is run for the length of the
historical period (from 1909-2013). If you want to reduce the length
of the simulation, navigate to the <code class="docutils literal notranslate"><span class="pre">.ctl</span></code> file and adjust the
<code class="docutils literal notranslate"><span class="pre">iystr</span></code> and <code class="docutils literal notranslate"><span class="pre">iyend</span></code> variables. For this notebook, these files are
located in:
<code class="docutils literal notranslate"><span class="pre">data/sj2015_StateMod_modified/sj2015_StateMod_modified/StateMod</span> <span class="pre">Notebook/sj2015.ctl</span></code>
and
<code class="docutils literal notranslate"><span class="pre">data/gm2015_StateMod_modified/gm2015_StateMod_modified/StateMod/gm2015.ctl</span></code></p>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># statemod directory
statemod_dir = &quot;/usr/src/statemodify/statemod_gunnison_sjd&quot;

# root directory of statemod data for the target basin
root_dir = os.path.join(statemod_dir, &quot;src&quot;, &quot;main&quot;, &quot;fortran&quot;)

# home directory of notebook instance
home_dir = os.path.dirname(os.getcwd())

# path to the statemod executable
statemod_exe = os.path.join(root_dir, &quot;statemod-17.0.3-gfortran-lin-64bit-o3&quot;)

# data directory and root name for the target basin
data_dir = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;sj2015_StateMod_modified&quot;,
    &quot;sj2015_StateMod_modified&quot;,
    &quot;StateMod&quot;
)

# directory to the target basin input files with root name for the basin
basin_path = os.path.join(data_dir, &quot;sj2015B&quot;)

# scenarios output directory
scenarios_dir_ddm = os.path.join(data_dir, &quot;scenarios_ddm&quot;)
scenarios_dir_ddr = os.path.join(data_dir, &quot;scenarios_ddr&quot;)

# parquet files output directory
parquet_dir_ddm = os.path.join(data_dir, &quot;parquet_ddm&quot;)
parquet_dir_ddr = os.path.join(data_dir, &quot;parquet_ddr&quot;)

# path to ddm and ddr template file
ddm_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;sj2015B_template_ddm.rsp&quot;
)

ddr_template_file = os.path.join(
    home_dir,
    &quot;data&quot;,
    &quot;sj2015B_template_ddr.rsp&quot;
)
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># run statemod
subprocess.call([statemod_exe, basin_path, &quot;-simulate&quot;])
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">sj2015B</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">sj2015B</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">sj2015B</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Once StateMod has run successfully, we can now extract user shortages
from the
<code class="docutils literal notranslate"><span class="pre">`.xdd</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/521/">https://opencdss.state.co.us/statemod/latest/doc-user/OutputDescription/521/</a>&gt;`__
output file using the <code class="docutils literal notranslate"><span class="pre">statemodify</span></code> output modification function
<code class="docutils literal notranslate"><span class="pre">convert_xdd()</span></code>. We denote a list of user IDs
(‘2900501’,‘2900519’,‘2900555’) who we want to extract shortages for and
then these shortages are saved in a compressed Parquet file format that
can then be read in as a Pandas dataframe in Python. We can also remove
the larger output files once the requested shortages have been extracted
and saved.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#Extract shortages using statemodify convert_xdd() function

# create a directory to store the historical shortages
output_dir = os.path.join(data_dir, &quot;historic_shortages&quot;)

# create a directory to store the new files in if it does not exist
output_directory = os.path.join(data_dir, &quot;historic_shortages&quot;)
if not os.path.exists(output_directory):
    os.makedirs(output_directory)

stm.xdd.convert_xdd(
    # path to a directory where output .parquet files should be written
    output_path=output_dir,
    # whether to abort if .parquet files already exist at the output_path
    allow_overwrite=True,
    # path, glob, or a list of paths/globs to the .xdd files you want to convert
    xdd_files=os.path.join(data_dir, &quot;*.xdd&quot;),
    # if the output .parquet files should only contain a subset of structure ids, list them here; None for all
    id_subset=[&#39;2900501&#39;,&#39;2900519&#39;,&#39;2900555&#39;],
    # how many .xdd files to convert in parallel; optimally you will want 2-4 CPUs per parallel process
    parallel_jobs=4,
    # convert to natural data types
    preserve_string_dtype=False
)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 29.32it/s]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data=pd.read_parquet(os.path.join(output_dir,&#39;sj2015B.parquet&#39;),engine=&#39;pyarrow&#39;)
data
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>structure_name</th>
      <th>structure_id</th>
      <th>river_id</th>
      <th>year</th>
      <th>month</th>
      <th>demand_total</th>
      <th>demand_cu</th>
      <th>from_river_by_priority</th>
      <th>from_river_by_storage</th>
      <th>from_river_by_other</th>
      <th>...</th>
      <th>station_in_out_return_flow</th>
      <th>station_in_out_well_deplete</th>
      <th>station_in_out_from_to_groundwater_storage</th>
      <th>station_balance_river_inflow</th>
      <th>station_balance_river_divert</th>
      <th>station_balance_river_by_well</th>
      <th>station_balance_river_outflow</th>
      <th>available_flow</th>
      <th>control_location</th>
      <th>control_right</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>15015</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1908</td>
      <td>OCT</td>
      <td>13.0</td>
      <td>7.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3792.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>3779.0</td>
      <td>2918.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15016</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1908</td>
      <td>NOV</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2343.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2343.0</td>
      <td>1510.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15017</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1908</td>
      <td>DEC</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1721.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1721.0</td>
      <td>860.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15018</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1909</td>
      <td>JAN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1512.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1512.0</td>
      <td>525.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>15019</th>
      <td>ALLEN CREEK DITCH</td>
      <td>2900501</td>
      <td>2900501</td>
      <td>1909</td>
      <td>FEB</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1370.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1370.0</td>
      <td>510.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>118750</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>JUN</td>
      <td>426.0</td>
      <td>81.0</td>
      <td>426.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>711.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>29239.0</td>
      <td>426.0</td>
      <td>0.0</td>
      <td>28813.0</td>
      <td>26410.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118751</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>JUL</td>
      <td>314.0</td>
      <td>88.0</td>
      <td>314.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>581.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9580.0</td>
      <td>314.0</td>
      <td>0.0</td>
      <td>9266.0</td>
      <td>7180.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118752</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>AUG</td>
      <td>203.0</td>
      <td>59.0</td>
      <td>203.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>524.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>20441.0</td>
      <td>203.0</td>
      <td>0.0</td>
      <td>20238.0</td>
      <td>18989.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118753</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>SEP</td>
      <td>144.0</td>
      <td>39.0</td>
      <td>144.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>454.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>42214.0</td>
      <td>144.0</td>
      <td>0.0</td>
      <td>42070.0</td>
      <td>41359.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>118754</th>
      <td>CARR DITCH</td>
      <td>2900555</td>
      <td>2900555</td>
      <td>2013</td>
      <td>TOT</td>
      <td>1341.0</td>
      <td>328.0</td>
      <td>1341.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>3395.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>228506.0</td>
      <td>1341.0</td>
      <td>0.0</td>
      <td>227165.0</td>
      <td>215605.0</td>
      <td>NA</td>
      <td>-1.0</td>
    </tr>
  </tbody>
</table>
<p>4095 rows × 36 columns</p>
</div><p>Upon inspecting the Parquet file above, we see the contents of the
<code class="docutils literal notranslate"><span class="pre">.xdd</span></code> file, including the shortages experienced by the structures
that we specified for the length of the historical period.</p>
<p>We can then take these shortages and plot them for our list of users.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots()

for name, group in data.groupby(&#39;structure_id&#39;):
    ax.scatter(
        group[&#39;year&#39;], group[&#39;shortage_total&#39;], label=name)

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7f17d8d6ea70</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_15_1.png" src="../_images/output_15_1.png" />
<p>You can look up the names and rights of the users listed above in the
<code class="docutils literal notranslate"><span class="pre">sj2015.ddr</span></code> file (found at
<code class="docutils literal notranslate"><span class="pre">data/sj2015_StateMod_modified/sj2015_StateMod_modified/StateMod/sj2015.ddr</span></code>).
Here, a higher Admin # denotes lower seniority. You’ll see that the
users chosen here have junior to medium seniority of water rights with
varying amounts of water decreed to them. The figure above shows that
all users have experienced shortages. User 2900501 has experienced the
most frequent shortages respectively, likely due in part to their less
senior water right. Generally, we see a higher magnitude of shortages
for all users during the 2002 drought.</p>
</section>
<section id="step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example">
<h2>Step 2a: Modify StateMod Input Files for Exploratory Analyses- Demand Function Example<a class="headerlink" href="#step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example" title="Link to this heading">#</a></h2>
<p>Now that we’ve run StateMod in baseline mode, the next step shows how we
can run it in an exploratory analysis mode. To do this, we need to
create some plausible futures and adjust the input files of StateMod to
reflect these changes. In this step, we’ll demonstrate Option 1 for
statemodify adjustments using the
<code class="docutils literal notranslate"><span class="pre">`.ddm</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/417/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/417/</a>&gt;`__
file as an example, which involves multiplying the current demand time
series for these users by a value in between 0.5 to 1.5. Here we specify
the IDs of the users and the bounds from which we want to sample
multipliers for the demand. We create 2 alternative states of the world
(SOW) using a Latin hypercube sampling (LHS) procedure and store them in
the <code class="docutils literal notranslate"><span class="pre">input_files</span></code> directory.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># a dictionary to describe what users you want to modify and the bounds for the LHS
setup_dict = {
    &quot;ids&quot;: [&quot;2900501&quot;, &quot;2900519&quot;,&quot;2900555&quot;],
    &quot;bounds&quot;: [0.5, 1.5]
}

output_directory = output_dir = os.path.join(data_dir, &quot;input_files&quot;)

scenario = &quot;1&quot;

# the number of samples you wish to generate
n_samples = 2

# seed value for reproducibility if so desired
seed_value = 1

# number of rows to skip in file after comment
skip_rows = 1

# name of field to query
query_field = &quot;id&quot;

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = -1

# basin to process
basin_name = &quot;San_Juan&quot;

# generate a batch of files using generated LHS
stm.modify_ddm(
    modify_dict=setup_dict,
    query_field=query_field,
    output_dir=output_directory,
    scenario=scenario,
    basin_name=basin_name,
    sampling_method=&quot;LHS&quot;,
    n_samples=n_samples,
    skip_rows=skip_rows,
    n_jobs=n_jobs,
    seed_value=seed_value,
    template_file=None,
    factor_method=&quot;multiply&quot;,
    data_specification_file=None,
    min_bound_value=-0.5,
    max_bound_value=1.5,
    save_sample=True
)
</pre></div>
</div>
<p>It’s helpful to set <code class="docutils literal notranslate"><span class="pre">save_sample=True</span></code> to see the values of the
multipliers that we are creating. We see below that in our 1st SOW, we
are reducing demand for our users by 30% and then in our 2nd SOW, we are
increasing demand for our users by 36%.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sample_array = np.load(output_directory+&#39;/ddm_2-samples_scenario-1.npy&#39;)
sample_array
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">0.708511</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">1.36016225</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example">
<h2>Step 2b: Read in the New Input Files and Run StateMod : Demand Function Example<a class="headerlink" href="#step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example" title="Link to this heading">#</a></h2>
<p>Now that we have created the input files, the next step is to run
StateMod with the new input files. The file that StateMod uses to
configure a simulation is called a
<code class="docutils literal notranslate"><span class="pre">`.rsp</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/41/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/41/</a>&gt;`__
file. For this dataset, the configuration file is <code class="docutils literal notranslate"><span class="pre">sj2015B.rsp</span></code>. This
file contains the paths of all of the supporting files that StateMod
needs to run. We create a template .rsp file
(<code class="docutils literal notranslate"><span class="pre">sj2015B_template_ddm.rsp</span></code>) and swap in the path to the two new
alternative <code class="docutils literal notranslate"><span class="pre">.ddm</span></code> files that are created. Then we run StateMod for
the two scenarios and store the shortages in Parquet file format. Each
scenario will take approximately 4 minutes.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 2, 1)

# read RSP template
with open(ddm_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;DDM&quot;: f&quot;../../input_files/sj2015B_{scenario}.ddm&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir_ddm, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}&quot;)

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])

        #Save output to parquet files
        print(&#39;creating parquet for &#39; + scenario)

        output_directory = os.path.join(parquet_dir_ddm+&quot;/scenario/&quot;+ scenario)

        if not os.path.exists(output_directory):
            os.makedirs(output_directory)

        stm.xdd.convert_xdd(
            output_path=output_directory,
            allow_overwrite=False,
            xdd_files=scenarios_dir_ddm + &quot;/&quot;+ scenario + &quot;/sj2015B_&quot;+scenario+&quot;.xdd&quot;,
            id_subset=[&#39;2900501&#39;,&#39;2900519&#39;,&#39;2900555&#39;],
            parallel_jobs=4,
            preserve_string_dtype=False
        )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
 <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddm</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddm</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddm</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
<span class="n">creating</span> <span class="n">parquet</span> <span class="k">for</span> <span class="n">S0_1</span>
</pre></div>
</div>
</section>
<section id="step-2c-visualize-shortages-in-new-sows-demand-function-example">
<h2>Step 2c: Visualize Shortages in New SOWs- Demand Function Example<a class="headerlink" href="#step-2c-visualize-shortages-in-new-sows-demand-function-example" title="Link to this heading">#</a></h2>
<p>Now that we have run our simulations, we can visualize the difference in
shortages experienced by the stakeholders in our two SOWs. Let’s focus
on the user: 2900501, a junior user who experienced the most frequent
shortages historically across the stakeholders we looked at. Let’s look
back at the LHS sample and see that SOW 1 is where we have a decreased
demand (0.7 multiplier) and SOW 2 is where we have an increased demand
(1.4 multiplier).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>output_directory = os.path.join(data_dir, &quot;input_files&quot;)
sample_array = np.load(output_directory+&#39;/ddm_2-samples_scenario-1.npy&#39;)
sample_array
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([[</span><span class="mf">0.708511</span>  <span class="p">],</span>
       <span class="p">[</span><span class="mf">1.36016225</span><span class="p">]])</span>
</pre></div>
</div>
<p>Now we can define shortages in the alternative states of the world with
respect to the shortages received in the baseline case.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Read in raw parquet files
baseline=pd.read_parquet(data_dir+&#39;/historic_shortages/sj2015B.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_1=pd.read_parquet(parquet_dir_ddm+&#39;/scenario/S0_1/sj2015B_S0_1.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_2=pd.read_parquet(parquet_dir_ddm+&#39;/scenario/S1_1/sj2015B_S1_1.parquet&#39;,engine=&#39;pyarrow&#39;)

# Subtract shortages with respect to the baseline
subset_df=pd.concat([baseline[&#39;year&#39;],baseline[&#39;shortage_total&#39;],SOW_1[&#39;shortage_total&#39;],SOW_2[&#39;shortage_total&#39;]],axis=1)
subset_df = subset_df.set_axis([&#39;Year&#39;, &#39;Baseline&#39;, &#39;SOW_1&#39;,&#39;SOW_2&#39;], axis=1)
subset_df[&#39;SOW_1_diff&#39;] = subset_df[&#39;SOW_1&#39;]-subset_df[&#39;Baseline&#39;]
subset_df[&#39;SOW_2_diff&#39;] = subset_df[&#39;SOW_2&#39;]-subset_df[&#39;Baseline&#39;]

# Plot shortages
fig, ax = plt.subplots()

ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;SOW_1_diff&#39;],label=&#39;Decreased Demand&#39;)
ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;SOW_2_diff&#39;],label=&#39;Increased Demand&#39;)

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.title(&quot;Change in Shortages from the Baseline&quot;)
plt.legend()
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x7fd2d4fcae90</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/output_29_1.png" src="../_images/output_29_1.png" />
<p>As expected, we see that an increase in demand typically causes an
increase in shortage magnitude and frequency whereas the reduction in
demand leads to the opposite. This finishes our simple example to
demonstrate how adjustments to demand might change the shortages
experienced by a user.</p>
</section>
<section id="step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example">
<h2>Step 3a: Modify StateMod Input Files for Exploratory Analyses- Water Rights Function Example<a class="headerlink" href="#step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example" title="Link to this heading">#</a></h2>
<p>Following from Step 2, we can run the same analysis for the function
that manipulates the <code class="docutils literal notranslate"><span class="pre">sj2015.ddr</span></code> file, which corresponds to users
water rights. In this function, we can specify the IDs of the users and
can can utilize a variety of options for how we want to change the
<code class="docutils literal notranslate"><span class="pre">`.ddr</span></code> &lt;<a class="reference external" href="https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/46/">https://opencdss.state.co.us/statemod/latest/doc-user/InputDescription/46/</a>&gt;`__
file. We can either sample from some bounds that apply multipliers to
the decree, hard code in values for the decree, or adjust the rank of
the user. In this simple example, we take a very junior user, ID:
2900501, and make them have the highest water right by changing their
rank to 1.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># a dictionary to describe what you want to modify and the bounds for the LHS
setup_dict = {
    # ids can either be &#39;struct&#39; or &#39;id&#39; values
    &quot;ids&quot;: [&quot;2900501&quot;],

    # turn id on or off completely or for a given period
    # if 0 = off, 1 = on, YYYY = on for years &gt;= YYYY, -YYYY = off for years &gt; YYYY; see file header
    &quot;on_off&quot;: [1],

    # apply rank of administrative order where 0 is lowest (senior) and n is highest (junior); None is no change
    &quot;admin&quot;: [1],
}

output_directory = os.path.join(data_dir, &quot;input_files&quot;)
scenario = &quot;1&quot;

# the number of samples you wish to generate
n_samples = 1

# seed value for reproducibility if so desired
seed_value = 1

# number of rows to skip in file after comment
skip_rows = 0

# name of field to query
query_field = &quot;struct&quot;

# number of jobs to launch in parallel; -1 is all but 1 processor used
n_jobs = -1

# basin to process
basin_name = &quot;San_Juan&quot;

# generate a batch of files using generated LHS
stm.modify_ddr(
    modify_dict=setup_dict,
    query_field=query_field,
    output_dir=output_directory,
    scenario=scenario,
    basin_name=basin_name,
    sampling_method=&quot;LHS&quot;,
    n_samples=n_samples,
    skip_rows=skip_rows,
    n_jobs=n_jobs,
    seed_value=seed_value,
    template_file=None,
    factor_method=&quot;multiply&quot;,
    data_specification_file=None,
    min_bound_value=-0.5,
    max_bound_value=1.5,
    save_sample=True
)
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">input_files</span></code> directory, you can open the <code class="docutils literal notranslate"><span class="pre">sj2015B_S0_1.ddr</span></code>
file and see that the Admin # of our selected user has now become
1.0000. Now we rerun our code to do the StateMod simulation, this time
using the .<code class="docutils literal notranslate"><span class="pre">ddr</span></code> template file.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># set realization and sample
realization = 1
sample = np.arange(0, 1, 1)

# read RSP template
with open(ddr_template_file) as template_obj:

    # read in file
    template_rsp = Template(template_obj.read())

    for i in sample:

        # create scenario name
        scenario = f&quot;S{i}_{realization}&quot;

        # dictionary holding search keys and replacement values to update the template file
        d = {&quot;DDR&quot;: f&quot;../../input_files/sj2015B_{scenario}.ddr&quot;}

        # update the template
        new_rsp = template_rsp.safe_substitute(d)

        # construct simulated scenario directory
        simulated_scenario_dir = os.path.join(scenarios_dir_ddr, scenario)
        if not os.path.exists(simulated_scenario_dir):
            os.makedirs(simulated_scenario_dir)

        # target rsp file
        rsp_file = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}.rsp&quot;)

        # write updated rsp file
        with open(rsp_file, &quot;w&quot;) as f1:
            f1.write(new_rsp)

        # construct simulated basin path
        simulated_basin_path = os.path.join(simulated_scenario_dir, f&quot;sj2015B_{scenario}&quot;)

        # run StateMod
        print(f&quot;Running: {scenario}&quot;)
        os.chdir(simulated_scenario_dir)

        subprocess.call([statemod_exe, simulated_basin_path, &quot;-simulate&quot;])

        #Save output to parquet files
        print(&#39;creating parquet for &#39; + scenario)

        output_directory = os.path.join(parquet_dir_ddr+&quot;/scenario/&quot;+ scenario)

        if not os.path.exists(output_directory):
            os.makedirs(output_directory)

        stm.xdd.convert_xdd(
            output_path=output_directory,
            allow_overwrite=False,
            xdd_files=scenarios_dir_ddr + &quot;/&quot;+ scenario + &quot;/sj2015B_&quot;+scenario+&quot;.xdd&quot;,
            id_subset=[&#39;2900501&#39;],
            parallel_jobs=2,
            preserve_string_dtype=False
        )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span><span class="p">:</span> <span class="n">S0_1</span>
 <span class="n">Startup</span> <span class="n">log</span> <span class="n">file</span> <span class="k">for</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">this</span> <span class="n">point</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddr</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">rsp</span>
   <span class="n">Closing</span> <span class="n">startup</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="n">statem</span><span class="o">.</span><span class="n">log</span>
   <span class="n">Opening</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddr</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
<span class="n">________________________________________________________________________</span>

        <span class="n">StateMod</span>
        <span class="n">State</span> <span class="n">of</span> <span class="n">Colorado</span> <span class="o">-</span> <span class="n">Water</span> <span class="n">Supply</span> <span class="n">Planning</span> <span class="n">Model</span>

        <span class="n">Version</span><span class="p">:</span>     <span class="mf">17.0.3</span>
        <span class="n">Last</span> <span class="n">revision</span> <span class="n">date</span><span class="p">:</span> <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">12</span>

<span class="n">________________________________________________________________________</span>

  <span class="n">Subroutine</span> <span class="n">Execut</span>
  <span class="n">Subroutine</span> <span class="n">Datinp</span>

<span class="o">...</span>

<span class="n">________________________________________________________________________</span>
  <span class="n">Execut</span><span class="p">;</span> <span class="n">Successful</span> <span class="n">Termination</span>
  <span class="n">Statem</span><span class="p">;</span> <span class="n">See</span> <span class="n">detailed</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="n">log</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">sj2015_StateMod_modified</span><span class="o">/</span><span class="n">StateMod</span><span class="o">/</span><span class="n">scenarios_ddr</span><span class="o">/</span><span class="n">S0_1</span><span class="o">/</span><span class="n">sj2015B_S0_1</span><span class="o">.</span><span class="n">log</span>
 <span class="n">Stop</span> <span class="mi">0</span>
<span class="n">creating</span> <span class="n">parquet</span> <span class="k">for</span> <span class="n">S0_1</span>
</pre></div>
</div>
<p>As before, let’s go ahead and plot the shortages for our User 2900501
with respect to the baseline shortages.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Read in raw parquet files
baseline=pd.read_parquet(data_dir+&#39;/historic_shortages/sj2015B.parquet&#39;,engine=&#39;pyarrow&#39;)
SOW_1=pd.read_parquet(parquet_dir_ddr+ &#39;/scenario/S0_1/sj2015B_S0_1.parquet&#39;,engine=&#39;pyarrow&#39;)

# Subtract shortages with respect to the baseline
subset_df=pd.concat([baseline[&#39;year&#39;],baseline[&#39;shortage_total&#39;],SOW_1[&#39;shortage_total&#39;]],axis=1)
subset_df = subset_df.set_axis([&#39;Year&#39;, &#39;Baseline&#39;, &#39;SOW_1&#39;], axis=1)
subset_df[&#39;diff&#39;]=subset_df[&#39;SOW_1&#39;]-subset_df[&#39;Baseline&#39;]

# Plot shortages
fig, ax = plt.subplots()

ax.scatter(subset_df[&#39;Year&#39;], subset_df[&#39;diff&#39;])

plt.xlabel(&quot;Year&quot;)
plt.ylabel(&quot;Shortage (AF)&quot;)
plt.title(&quot;Change in Shortages from the Baseline&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Change in Shortages from the Baseline&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_37_1.png" src="../_images/output_37_1.png" />
<p>We generally see the behavior we expect to see which is that with more
senior water rights, the user sees a decrease in shortage magnitude.</p>
<p>Now, continue on to Quickstarter Notebook #2 to learn how to use the
reservoir evaporation modification fuction.</p>
<div class="alert alert-block alert-warning docutils container">
<p>Tip: If you are interested in understanding how to apply
<code class="docutils literal notranslate"><span class="pre">statemodify</span></code> functions to your own model, take a look at the
source code found in the repository here:</p>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/ddm.py&quot;</span><span class="o">&gt;</span><span class="n">modify_ddm</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.</span>  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/IMMM-SFA/statemodify/blob/main/statemodify/ddr.py&quot;</span><span class="o">&gt;</span><span class="n">modify_ddr</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-run-a-historical-simulation-in-statemod-for-the-san-juan-basin">Step 1: Run a Historical Simulation in StateMod for the San Juan Basin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2a-modify-statemod-input-files-for-exploratory-analyses-demand-function-example">Step 2a: Modify StateMod Input Files for Exploratory Analyses- Demand Function Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2b-read-in-the-new-input-files-and-run-statemod-demand-function-example">Step 2b: Read in the New Input Files and Run StateMod : Demand Function Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2c-visualize-shortages-in-new-sows-demand-function-example">Step 2c: Visualize Shortages in New SOWs- Demand Function Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3a-modify-statemod-input-files-for-exploratory-analyses-water-rights-function-example">Step 3a: Modify StateMod Input Files for Exploratory Analyses- Water Rights Function Example</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Rohini S. Gupta
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, Battelle Memorial Institute.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>